# ุฎุทุฉ Capacitor ูุชุชุจุน ุงููููุน - ุฏููู ุดุงูู

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงูุฏููู ุงูุดุงูู ูุชุทุจูู ูุธุงู ุชุชุจุน ุงููููุน ุจุงุณุชุฎุฏุงู Capacitorุ ููุง ูููุฑ ุชุชุจุน ุญูููู ูู ุงูุฎูููุฉ ุญุชู ุจุนุฏ ุฅุบูุงู ุงูุชุทุจูู ุฃู ุชุณุฌูู ุงูุฎุฑูุฌ.

---

## ๐ฏ ุงููุฏู ูู ุงููุดุฑูุน

**ุงููุดููุฉ ุงูุญุงููุฉ:**
- ุงููุธุงู ุงูุญุงูู ูุชููู ุนูุฏ ุฅุบูุงู ุงูุชุจููุจ
- ูุง ูุนูู ุจุนุฏ ุชุณุฌูู ุงูุฎุฑูุฌ
- ูุญุฏูุฏ ุจู Service Workers

**ุงูุญู ุงูููุชุฑุญ:**
- ุชุทุจูู ูุฌูู ุจุงุณุชุฎุฏุงู Capacitor
- ุชุชุจุน ุญูููู ูู ุงูุฎูููุฉ
- ูุนูู ุจุนุฏ ุฅุบูุงู ุงูุชุทุจูู
- ูุฌุงูู 100%

---

## ๐๏ธ ุงูุชูููุงุช ุงููุณุชุฎุฏูุฉ

### **Frontend:**
- **Capacitor** - ููุตุฉ ุงูุชุทุจููุงุช ุงููุฌููุฉ
- **JavaScript ES6+** - ูุบุฉ ุงูุจุฑูุฌุฉ
- **HTML5/CSS3** - ูุงุฌูุฉ ุงููุณุชุฎุฏู
- **PWA** - ุฏุนู ุงูุชุทุจููุงุช ุงูุชูุฏููุฉ

### **Backend:**
- **Laravel 12** - ุฅุทุงุฑ ุงูุนูู
- **MySQL** - ูุงุนุฏุฉ ุงูุจูุงูุงุช
- **REST API** - ูุงุฌูุฉ ุงูุจุฑูุฌุฉ

### **Mobile:**
- **Android** - ููุตุฉ Android
- **iOS** - ููุตุฉ iOS
- **Native APIs** - APIs ุฃุตููุฉ

---

## ๐ฑ ูููุฒุงุช Capacitor

### **1. ุงูุฃุฏุงุก ุงูุนุงูู**
- ุฃุณุฑุน ูู Cordova
- ุงุณุชุฎุฏุงู WebView ูุญุณู
- ุฏุนู JavaScript ุงูุญุฏูุซ

### **2. ุณูููุฉ ุงูุชุทููุฑ**
- APIs ุญุฏูุซุฉ ููุงุถุญุฉ
- ุชูุซูู ููุชุงุฒ
- ูุฌุชูุน ูุดุท

### **3. ุฏุนู PWA**
- ูููู ุชุญููู PWA ุฅูู ุชุทุจูู ุฃุตูู
- ููุณ ุงูููุฏ ูุนูู ูู ุงููุชุตูุญ ูุงูุชุทุจูู
- ุชุญุฏูุซุงุช OTA

### **4. ูุฌุงูู ุชูุงูุงู**
- ูุง ุชูุฌุฏ ุฑุณูู ุชุฑุฎูุต
- ููุชูุญ ุงููุตุฏุฑ
- ุฏุนู ูุฌุชูุนู

---

## ๐ ุฎุทุฉ ุงูุชูููุฐ

### **ุงููุฑุญูุฉ 1: ุงูุฅุนุฏุงุฏ ูุงูุชุญุถูุฑ (3 ุฃูุงู)**

#### **ุงูููู 1: ุชุซุจูุช ุงูุฃุฏูุงุช**
```bash
# ุชุซุจูุช Node.js (ุฅุฐุง ูู ููู ูุซุจุช)
# ุชุญููู ูู: https://nodejs.org/

# ุชุซุจูุช Capacitor
npm install -g @capacitor/cli

# ุชุซุจูุช ูู ุงููุดุฑูุน
npm install @capacitor/core @capacitor/cli
```

#### **ุงูููู 2: ุฅุนุฏุงุฏ ุงููุดุฑูุน**
```bash
# ุชููุฆุฉ Capacitor
npx cap init "Massar Location Tracker" "com.massar.location"

# ุฅุถุงูุฉ ุงูููุตุงุช
npx cap add android
npx cap add ios

# ุฅุถุงูุฉ Plugins ุงููุทููุจุฉ
npm install @capacitor/geolocation
npm install @capacitor-community/background-mode
npm install @capacitor/storage
npm install @capacitor/network
npm install @capacitor/app
```

#### **ุงูููู 3: ุฅุนุฏุงุฏ ุงูุจูุฆุฉ**
```bash
# ุชุซุจูุช Android Studio
# ุชุญููู ูู: https://developer.android.com/studio

# ุชุซุจูุช Xcode (ูููุทูุฑูู)
# ูู App Store

# ุฅุนุฏุงุฏ ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ
```

### **ุงููุฑุญูุฉ 2: ุงูุชุทููุฑ (ุฃุณุจูุน)**

#### **ุงูููู 4-5: ุชุทููุฑ Location Tracker**
```javascript
// ุฅูุดุงุก ููู: public/assets/js/capacitor-location-tracker.js
import { Capacitor } from '@capacitor/core';
import { Geolocation } from '@capacitor/geolocation';
import { BackgroundMode } from '@capacitor-community/background-mode';
import { Storage } from '@capacitor/storage';
import { Network } from '@capacitor/network';

class CapacitorLocationTracker {
    constructor() {
        this.trackingInterval = 30 * 60 * 1000; // 30 ุฏูููุฉ
        this.trackingDuration = 10 * 60 * 60 * 1000; // 10 ุณุงุนุงุช
        this.isTracking = false;
        this.watchId = null;
        this.retryCount = 0;
        this.maxRetries = 3;
    }
    
    async init() {
        try {
            console.log('Initializing Capacitor Location Tracker...');
            
            // ุงูุชุญูู ูู ุงูููุตุฉ
            if (Capacitor.isNativePlatform()) {
                console.log('Running on native platform');
                await this.setupNativeFeatures();
            } else {
                console.log('Running on web platform');
                await this.setupWebFeatures();
            }
            
            // ุจุฏุก ุงูุชุชุจุน
            await this.startTracking();
            
        } catch (error) {
            console.error('Capacitor Location Tracker Error:', error);
        }
    }
    
    async setupNativeFeatures() {
        // ุชูุนูู ูุถุน ุงูุฎูููุฉ
        await BackgroundMode.enable();
        await this.setupBackgroundMode();
        
        // ุฅุนุฏุงุฏ ูุฑุงูุจุฉ ุงูุดุจูุฉ
        await this.setupNetworkMonitoring();
    }
    
    async setupWebFeatures() {
        // ุฅุนุฏุงุฏ Service Worker ููุชุทุจููุงุช ุงูููุจ
        if ('serviceWorker' in navigator) {
            await navigator.serviceWorker.register('/service-worker.js');
        }
    }
    
    async setupBackgroundMode() {
        await BackgroundMode.setDefaults({
            title: 'Massar Location Tracker',
            text: 'Tracking your location...',
            icon: 'icon',
            color: '#000000',
            resume: true,
            silent: false
        });
        
        // ุนูุฏ ุชูุนูู ุงูุฎูููุฉ
        BackgroundMode.on('activate').subscribe(() => {
            console.log('App is in background mode');
            this.handleBackgroundActivation();
        });
        
        // ุนูุฏ ุงูุนูุฏุฉ ููููุฏูุฉ
        BackgroundMode.on('deactivate').subscribe(() => {
            console.log('App is back in foreground');
            this.handleForegroundActivation();
        });
    }
    
    async setupNetworkMonitoring() {
        Network.addListener('networkStatusChange', (status) => {
            console.log('Network status changed:', status);
            if (status.connected) {
                this.syncPendingLocations();
            }
        });
    }
    
    async startTracking() {
        if (this.isTracking) {
            console.log('Tracking already started');
            return;
        }
        
        console.log('Starting location tracking...');
        this.isTracking = true;
        
        // ุงูุชูุงุท ุงููููุน ุงูุฃูู
        await this.captureLocation('login');
        
        // ุจุฏุก ุงูุชุชุจุน ุงููุณุชูุฑ
        await this.startContinuousTracking();
        
        // ุฅููุงู ุงูุชุชุจุน ุจุนุฏ ุงููุฏุฉ ุงููุญุฏุฏุฉ
        setTimeout(() => {
            this.stopTracking();
        }, this.trackingDuration);
    }
    
    async startContinuousTracking() {
        this.watchId = await Geolocation.watchPosition(
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            },
            (position, err) => {
                if (err) {
                    console.error('Location error:', err);
                    this.handleLocationError(err);
                    return;
                }
                
                this.handleLocationUpdate(position);
            }
        );
    }
    
    async captureLocation(type) {
        try {
            console.log(`Capturing location for type: ${type}`);
            
            const coordinates = await Geolocation.getCurrentPosition({
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
            
            await this.sendLocationToServer(coordinates, type);
            
        } catch (error) {
            console.error('Failed to capture location:', error);
            this.handleLocationError(error);
        }
    }
    
    async handleLocationUpdate(position) {
        console.log('Location updated:', position);
        await this.sendLocationToServer(position, 'tracking');
    }
    
    async handleLocationError(error) {
        console.error('Location error:', error);
        
        // ุฅุนุงุฏุฉ ุงููุญุงููุฉ
        if (this.retryCount < this.maxRetries) {
            this.retryCount++;
            console.log(`Retrying location capture (${this.retryCount}/${this.maxRetries})`);
            
            setTimeout(() => {
                this.captureLocation('retry');
            }, 5000);
        } else {
            console.error('Max retries reached, stopping tracking');
            this.stopTracking();
        }
    }
    
    async sendLocationToServer(position, type) {
        try {
            const userId = await Storage.get({ key: 'user_id' });
            const apiKey = await Storage.get({ key: 'api_key' });
            
            if (!userId.value || !apiKey.value) {
                console.error('User ID or API Key not found');
                return;
            }
            
            const locationData = {
                user_id: userId.value,
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
                tracked_at: new Date().toISOString(),
                type: type,
                session_id: await this.getSessionId()
            };
            
            console.log('Sending location to server:', locationData);
            
            const response = await fetch('/api/location/track', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': apiKey.value
                },
                body: JSON.stringify(locationData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('Location sent successfully:', result);
            
            // ุฅุนุงุฏุฉ ุชุนููู ุนุฏุงุฏ ุงููุญุงููุงุช
            this.retryCount = 0;
            
        } catch (error) {
            console.error('Failed to send location:', error);
            
            // ุญูุธ ูุญููุงู ูููุฒุงููุฉ ูุงุญูุงู
            await this.storeLocationLocally(locationData);
        }
    }
    
    async storeLocationLocally(locationData) {
        try {
            const stored = await Storage.get({ key: 'pending_locations' });
            const locations = stored.value ? JSON.parse(stored.value) : [];
            
            locations.push({
                ...locationData,
                synced: false,
                timestamp: Date.now()
            });
            
            await Storage.set({
                key: 'pending_locations',
                value: JSON.stringify(locations)
            });
            
            console.log('Location stored locally for later sync');
            
        } catch (error) {
            console.error('Failed to store location locally:', error);
        }
    }
    
    async syncPendingLocations() {
        try {
            const stored = await Storage.get({ key: 'pending_locations' });
            const locations = stored.value ? JSON.parse(stored.value) : [];
            
            const unsynced = locations.filter(loc => !loc.synced);
            
            for (const location of unsynced) {
                try {
                    await this.sendLocationToServer(location, location.type);
                    
                    // ุชุญุฏูุซ ุญุงูุฉ ุงููุฒุงููุฉ
                    location.synced = true;
                    
                } catch (error) {
                    console.error('Failed to sync location:', error);
                }
            }
            
            // ุญูุธ ุงูููุงูุน ุงููุญุฏุซุฉ
            await Storage.set({
                key: 'pending_locations',
                value: JSON.stringify(locations)
            });
            
            console.log(`Synced ${unsynced.length} pending locations`);
            
        } catch (error) {
            console.error('Failed to sync pending locations:', error);
        }
    }
    
    async getSessionId() {
        let sessionId = await Storage.get({ key: 'session_id' });
        
        if (!sessionId.value) {
            sessionId.value = this.generateSessionId();
            await Storage.set({
                key: 'session_id',
                value: sessionId.value
            });
        }
        
        return sessionId.value;
    }
    
    generateSessionId() {
        return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    async handleBackgroundActivation() {
        console.log('Handling background activation');
        // ูููู ุฅุถุงูุฉ ููุทู ุฅุถุงูู ููุง
    }
    
    async handleForegroundActivation() {
        console.log('Handling foreground activation');
        // ูุฒุงููุฉ ุงูููุงูุน ุงููุนููุฉ
        await this.syncPendingLocations();
    }
    
    async stopTracking() {
        console.log('Stopping location tracking...');
        
        if (this.watchId) {
            await Geolocation.clearWatch({ id: this.watchId });
            this.watchId = null;
        }
        
        this.isTracking = false;
        
        if (Capacitor.isNativePlatform()) {
            await BackgroundMode.disable();
        }
        
        console.log('Location tracking stopped');
    }
}

// ุชุตุฏูุฑ ุงูููุงุณ
window.CapacitorLocationTracker = CapacitorLocationTracker;
```

#### **ุงูููู 6-7: ุชุทููุฑ ูุงุฌูุฉ ุงููุณุชุฎุฏู**
```html
<!-- ุฅูุดุงุก ููู: resources/views/admin/capacitor-dashboard.blade.php -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta name="user-id" content="{{ auth()->id() }}">
    <title>Massar Location Tracker</title>
    
    <!-- Bootstrap RTL -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <style>
        .tracking-status {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .tracking-active {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .tracking-inactive {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .location-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .btn-track {
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 25px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center my-4">Massar Location Tracker</h1>
                
                <!-- ุญุงูุฉ ุงูุชุชุจุน -->
                <div id="tracking-status" class="tracking-status tracking-inactive">
                    <h3>ุญุงูุฉ ุงูุชุชุจุน: <span id="status-text">ุบูุฑ ูุดุท</span></h3>
                    <p id="status-description">ุงูุชุชุจุน ุบูุฑ ููุนู ุญุงููุงู</p>
                </div>
                
                <!-- ูุนูููุงุช ุงููููุน ุงูุญุงูู -->
                <div class="location-info">
                    <h4>ุงููููุน ุงูุญุงูู</h4>
                    <div id="current-location">
                        <p><strong>ุฎุท ุงูุนุฑุถ:</strong> <span id="latitude">-</span></p>
                        <p><strong>ุฎุท ุงูุทูู:</strong> <span id="longitude">-</span></p>
                        <p><strong>ุงูุฏูุฉ:</strong> <span id="accuracy">-</span> ูุชุฑ</p>
                        <p><strong>ุขุฎุฑ ุชุญุฏูุซ:</strong> <span id="last-update">-</span></p>
                    </div>
                </div>
                
                <!-- ุฃุฒุฑุงุฑ ุงูุชุญูู -->
                <div class="text-center">
                    <button id="start-tracking" class="btn btn-success btn-track me-3">
                        ุจุฏุก ุงูุชุชุจุน
                    </button>
                    <button id="stop-tracking" class="btn btn-danger btn-track me-3" disabled>
                        ุฅููุงู ุงูุชุชุจุน
                    </button>
                    <button id="sync-locations" class="btn btn-info btn-track">
                        ูุฒุงููุฉ ุงูููุงูุน
                    </button>
                </div>
                
                <!-- ุฅุญุตุงุฆูุงุช ุงูุชุชุจุน -->
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">ุงูููุงูุน ุงููุฑุณูุฉ</h5>
                                <h2 id="sent-count" class="text-primary">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">ุงูููุงูุน ุงููุนููุฉ</h5>
                                <h2 id="pending-count" class="text-warning">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">ูุฏุฉ ุงูุชุชุจุน</h5>
                                <h2 id="tracking-duration" class="text-success">00:00:00</h2>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ุณุฌู ุงูููุงูุน -->
                <div class="mt-4">
                    <h4>ุณุฌู ุงูููุงูุน ุงูุฃุฎูุฑุฉ</h4>
                    <div id="location-history" class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ุงูููุช</th>
                                    <th>ุงูููุน</th>
                                    <th>ุฎุท ุงูุนุฑุถ</th>
                                    <th>ุฎุท ุงูุทูู</th>
                                    <th>ุงูุฏูุฉ</th>
                                    <th>ุงูุญุงูุฉ</th>
                                </tr>
                            </thead>
                            <tbody id="history-body">
                                <!-- ุณูุชู ููุคูุง ุจูุงุณุทุฉ JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Capacitor Core -->
    <script type="module">
        import { Capacitor } from '@capacitor/core';
        import { CapacitorLocationTracker } from '/assets/js/capacitor-location-tracker.js';
        
        class LocationTrackerUI {
            constructor() {
                this.tracker = null;
                this.isTracking = false;
                this.startTime = null;
                this.sentCount = 0;
                this.pendingCount = 0;
                
                this.initializeUI();
                this.setupEventListeners();
            }
            
            initializeUI() {
                // ุงูุชุญูู ูู ุงูููุตุฉ
                if (Capacitor.isNativePlatform()) {
                    document.getElementById('status-text').textContent = 'ููุตุฉ ุฃุตููุฉ';
                    document.getElementById('status-description').textContent = 'ูุนูู ุนูู ุชุทุจูู ุฃุตูู';
                } else {
                    document.getElementById('status-text').textContent = 'ููุตุฉ ููุจ';
                    document.getElementById('status-description').textContent = 'ูุนูู ุนูู ูุชุตูุญ ุงูููุจ';
                }
            }
            
            setupEventListeners() {
                document.getElementById('start-tracking').addEventListener('click', () => {
                    this.startTracking();
                });
                
                document.getElementById('stop-tracking').addEventListener('click', () => {
                    this.stopTracking();
                });
                
                document.getElementById('sync-locations').addEventListener('click', () => {
                    this.syncLocations();
                });
            }
            
            async startTracking() {
                try {
                    if (!this.tracker) {
                        this.tracker = new CapacitorLocationTracker();
                    }
                    
                    await this.tracker.init();
                    
                    this.isTracking = true;
                    this.startTime = new Date();
                    
                    this.updateUI();
                    this.startDurationTimer();
                    
                    console.log('Tracking started successfully');
                    
                } catch (error) {
                    console.error('Failed to start tracking:', error);
                    alert('ูุดู ูู ุจุฏุก ุงูุชุชุจุน: ' + error.message);
                }
            }
            
            async stopTracking() {
                try {
                    if (this.tracker) {
                        await this.tracker.stopTracking();
                    }
                    
                    this.isTracking = false;
                    this.startTime = null;
                    
                    this.updateUI();
                    this.stopDurationTimer();
                    
                    console.log('Tracking stopped successfully');
                    
                } catch (error) {
                    console.error('Failed to stop tracking:', error);
                    alert('ูุดู ูู ุฅููุงู ุงูุชุชุจุน: ' + error.message);
                }
            }
            
            async syncLocations() {
                try {
                    if (this.tracker) {
                        await this.tracker.syncPendingLocations();
                    }
                    
                    this.updatePendingCount();
                    console.log('Locations synced successfully');
                    
                } catch (error) {
                    console.error('Failed to sync locations:', error);
                    alert('ูุดู ูู ูุฒุงููุฉ ุงูููุงูุน: ' + error.message);
                }
            }
            
            updateUI() {
                const statusDiv = document.getElementById('tracking-status');
                const statusText = document.getElementById('status-text');
                const statusDescription = document.getElementById('status-description');
                const startBtn = document.getElementById('start-tracking');
                const stopBtn = document.getElementById('stop-tracking');
                
                if (this.isTracking) {
                    statusDiv.className = 'tracking-status tracking-active';
                    statusText.textContent = 'ูุดุท';
                    statusDescription.textContent = 'ุงูุชุชุจุน ูุนูู ูู ุงูุฎูููุฉ';
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                } else {
                    statusDiv.className = 'tracking-status tracking-inactive';
                    statusText.textContent = 'ุบูุฑ ูุดุท';
                    statusDescription.textContent = 'ุงูุชุชุจุน ุบูุฑ ููุนู';
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                }
            }
            
            updateLocationInfo(latitude, longitude, accuracy) {
                document.getElementById('latitude').textContent = latitude.toFixed(6);
                document.getElementById('longitude').textContent = longitude.toFixed(6);
                document.getElementById('accuracy').textContent = Math.round(accuracy);
                document.getElementById('last-update').textContent = new Date().toLocaleString('ar-SA');
            }
            
            updateSentCount() {
                this.sentCount++;
                document.getElementById('sent-count').textContent = this.sentCount;
            }
            
            updatePendingCount() {
                // ูููู ุฅุถุงูุฉ ููุทู ูุญุณุงุจ ุงูููุงูุน ุงููุนููุฉ
                document.getElementById('pending-count').textContent = this.pendingCount;
            }
            
            startDurationTimer() {
                this.durationTimer = setInterval(() => {
                    if (this.startTime) {
                        const now = new Date();
                        const diff = now - this.startTime;
                        const hours = Math.floor(diff / 3600000);
                        const minutes = Math.floor((diff % 3600000) / 60000);
                        const seconds = Math.floor((diff % 60000) / 1000);
                        
                        const duration = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        document.getElementById('tracking-duration').textContent = duration;
                    }
                }, 1000);
            }
            
            stopDurationTimer() {
                if (this.durationTimer) {
                    clearInterval(this.durationTimer);
                    this.durationTimer = null;
                }
                document.getElementById('tracking-duration').textContent = '00:00:00';
            }
        }
        
        // ุชููุฆุฉ ูุงุฌูุฉ ุงููุณุชุฎุฏู
        document.addEventListener('DOMContentLoaded', () => {
            window.locationTrackerUI = new LocationTrackerUI();
        });
    </script>
</body>
</html>
```

#### **ุงูููู 8-10: ุชุทููุฑ Laravel API**
```php
<?php
// ุชุนุฏูู app/Http/Controllers/LocationController.php

namespace App\Http\Controllers;

use App\Models\User;
use App\Models\UserLocationTracking;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Validator;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Str;
use Carbon\Carbon;

class LocationController extends Controller
{
    /**
     * ุญูุธ ุจูุงูุงุช ุชุชุจุน ุงููููุน
     */
    public function storeTracking(Request $request)
    {
        // ุงูุชุญูู ูู API Key
        $apiKey = $request->header('X-API-Key');
        $user = User::where('api_key', $apiKey)
                    ->where('api_key_expires_at', '>', now())
                    ->first();
        
        if (!$user) {
            return response()->json([
                'success' => false,
                'error' => 'Invalid or expired API Key'
            ], 401);
        }
        
        // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
        $validator = Validator::make($request->all(), [
            'latitude' => 'required|numeric|between:-90,90',
            'longitude' => 'required|numeric|between:-180,180',
            'accuracy' => 'nullable|numeric|min:0',
            'tracked_at' => 'required|date',
            'type' => 'nullable|string|in:login,tracking,attendance,retry',
            'session_id' => 'nullable|string|max:255'
        ]);
        
        if ($validator->fails()) {
            return response()->json([
                'success' => false,
                'errors' => $validator->errors()
            ], 422);
        }
        
        try {
            // ุงุณุชุฎุฏุงู ุงูููุช ุงูุญุงูู ุจุงูู timezone ุงููุญูู
            $currentTime = Carbon::now(config('app.timezone'));
            
            $tracking = UserLocationTracking::create([
                'user_id' => $user->id,
                'latitude' => $request->latitude,
                'longitude' => $request->longitude,
                'accuracy' => $request->accuracy,
                'tracked_at' => $currentTime,
                'type' => $request->type ?? 'tracking',
                'session_id' => $request->session_id ?? Str::uuid(),
                'address' => $request->address,
                'place_id' => $request->place_id,
                'additional_data' => $request->additional_data ?? null,
            ]);
            
            return response()->json([
                'success' => true,
                'message' => 'Location tracked successfully',
                'data' => [
                    'id' => $tracking->id,
                    'tracked_at' => $tracking->tracked_at->format('Y-m-d H:i:s'),
                    'type' => $tracking->type
                ]
            ]);
            
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Failed to save location',
                'error' => $e->getMessage()
            ], 500);
        }
    }
    
    /**
     * ุงูุญุตูู ุนูู ุชุงุฑูุฎ ุงูููุงูุน
     */
    public function getHistory(Request $request)
    {
        $apiKey = $request->header('X-API-Key');
        $user = User::where('api_key', $apiKey)
                    ->where('api_key_expires_at', '>', now())
                    ->first();
        
        if (!$user) {
            return response()->json([
                'success' => false,
                'error' => 'Invalid or expired API Key'
            ], 401);
        }
        
        $query = UserLocationTracking::where('user_id', $user->id)
                                    ->orderBy('tracked_at', 'desc');
        
        // ููุชุฑุฉ ุญุณุจ ุงูุชุงุฑูุฎ
        if ($request->has('date_from')) {
            $query->where('tracked_at', '>=', $request->date_from);
        }
        
        if ($request->has('date_to')) {
            $query->where('tracked_at', '<=', $request->date_to);
        }
        
        // ููุชุฑุฉ ุญุณุจ ุงูููุน
        if ($request->has('type')) {
            $query->where('type', $request->type);
        }
        
        $locations = $query->paginate($request->get('per_page', 50));
        
        return response()->json([
            'success' => true,
            'data' => $locations->items(),
            'pagination' => [
                'current_page' => $locations->currentPage(),
                'last_page' => $locations->lastPage(),
                'per_page' => $locations->perPage(),
                'total' => $locations->total()
            ]
        ]);
    }
    
    /**
     * ุงูุญุตูู ุนูู ุฅุญุตุงุฆูุงุช ุงูุชุชุจุน
     */
    public function getStats(Request $request)
    {
        $apiKey = $request->header('X-API-Key');
        $user = User::where('api_key', $apiKey)
                    ->where('api_key_expires_at', '>', now())
                    ->first();
        
        if (!$user) {
            return response()->json([
                'success' => false,
                'error' => 'Invalid or expired API Key'
            ], 401);
        }
        
        $today = Carbon::today();
        $thisWeek = Carbon::now()->startOfWeek();
        $thisMonth = Carbon::now()->startOfMonth();
        
        $stats = [
            'today' => UserLocationTracking::where('user_id', $user->id)
                                         ->whereDate('tracked_at', $today)
                                         ->count(),
            'this_week' => UserLocationTracking::where('user_id', $user->id)
                                              ->where('tracked_at', '>=', $thisWeek)
                                              ->count(),
            'this_month' => UserLocationTracking::where('user_id', $user->id)
                                               ->where('tracked_at', '>=', $thisMonth)
                                               ->count(),
            'total' => UserLocationTracking::where('user_id', $user->id)->count()
        ];
        
        return response()->json([
            'success' => true,
            'data' => $stats
        ]);
    }
}
```

```php
<?php
// ุฅุถุงูุฉ methods ุฌุฏูุฏุฉ ูู app/Models/User.php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;
use Illuminate\Support\Str;

class User extends Authenticatable
{
    use HasFactory, Notifiable;
    
    // ... existing code ...
    
    /**
     * ุฅูุดุงุก API Key ุฌุฏูุฏ ูููุณุชุฎุฏู
     */
    public function generateApiKey($expiresInDays = 30)
    {
        $this->api_key = Str::random(60);
        $this->api_key_expires_at = now()->addDays($expiresInDays);
        $this->save();
        
        return $this->api_key;
    }
    
    /**
     * ุงูุชุญูู ูู ุตุญุฉ API Key
     */
    public function isApiKeyValid()
    {
        return $this->api_key && 
               $this->api_key_expires_at && 
               $this->api_key_expires_at->isFuture();
    }
    
    /**
     * ุชุฌุฏูุฏ API Key
     */
    public function renewApiKey($expiresInDays = 30)
    {
        return $this->generateApiKey($expiresInDays);
    }
    
    /**
     * ุฅูุบุงุก API Key
     */
    public function revokeApiKey()
    {
        $this->api_key = null;
        $this->api_key_expires_at = null;
        $this->save();
    }
    
    /**
     * ุงูุนูุงูุฉ ูุน ุชุชุจุน ุงูููุงูุน
     */
    public function locationTrackings()
    {
        return $this->hasMany(UserLocationTracking::class);
    }
}
```

### **ุงููุฑุญูุฉ 3: ุงูุงุฎุชุจุงุฑ ูุงูุชุญุณูู (3 ุฃูุงู)**

#### **ุงูููู 11: ุงุฎุชุจุงุฑ ุงููุธุงุฆู ุงูุฃุณุงุณูุฉ**
```bash
# ุงุฎุชุจุงุฑ ุงูุชุชุจุน ูู ุงููุชุตูุญ
# ุงุฎุชุจุงุฑ API endpoints
# ุงุฎุชุจุงุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช
```

#### **ุงูููู 12: ุงุฎุชุจุงุฑ ุงูุชุทุจูู ุงูุฃุตูู**
```bash
# ุจูุงุก ุงูุชุทุจูู
npm run build
npx cap sync

# ุงุฎุชุจุงุฑ ุนูู Android
npx cap run android

# ุงุฎุชุจุงุฑ ุนูู iOS
npx cap run ios
```

#### **ุงูููู 13: ุงูุชุญุณูู ูุงูุฃุฏุงุก**
```javascript
// ุชุญุณููุงุช ุงูุฃุฏุงุก
// ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
// ุชุญุณูู ูุงุฌูุฉ ุงููุณุชุฎุฏู
```

---

## ๐๏ธ ูุงุนุฏุฉ ุงูุจูุงูุงุช

### **Migration ูู API Keys**
```php
<?php
// database/migrations/xxxx_xx_xx_add_api_key_to_users_table.php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class AddApiKeyToUsersTable extends Migration
{
    public function up()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->string('api_key')->unique()->nullable()->after('remember_token');
            $table->timestamp('api_key_expires_at')->nullable()->after('api_key');
        });
    }
    
    public function down()
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn(['api_key', 'api_key_expires_at']);
        });
    }
}
```

### **ุชุญุฏูุซ ุฌุฏูู ุชุชุจุน ุงูููุงูุน**
```php
<?php
// database/migrations/xxxx_xx_xx_update_user_location_tracking_table.php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class UpdateUserLocationTrackingTable extends Migration
{
    public function up()
    {
        Schema::table('user_location_tracking', function (Blueprint $table) {
            // ุฅุถุงูุฉ ููุงุฑุณ ููุฃุฏุงุก
            $table->index(['user_id', 'tracked_at']);
            $table->index(['type', 'tracked_at']);
            
            // ุฅุถุงูุฉ ุญูู ููุจูุงูุงุช ุงูุฅุถุงููุฉ
            $table->json('additional_data')->nullable()->after('place_id');
        });
    }
    
    public function down()
    {
        Schema::table('user_location_tracking', function (Blueprint $table) {
            $table->dropIndex(['user_id', 'tracked_at']);
            $table->dropIndex(['type', 'tracked_at']);
            $table->dropColumn('additional_data');
        });
    }
}
```

---

## ๐ฃ๏ธ Routes ุงูุฌุฏูุฏุฉ

```php
<?php
// routes/api.php

use App\Http\Controllers\LocationController;

// API routes ูุชุชุจุน ุงููููุน (ุจุฏูู auth:web)
Route::post('/location/track', [LocationController::class, 'storeTracking'])
    ->name('api.location.track')
    ->middleware(['throttle:60,1']);

Route::get('/location/history', [LocationController::class, 'getHistory'])
    ->name('api.location.history')
    ->middleware(['throttle:60,1']);

Route::get('/location/stats', [LocationController::class, 'getStats'])
    ->name('api.location.stats')
    ->middleware(['throttle:60,1']);
```

```php
<?php
// routes/web.php

// ุตูุญุฉ Capacitor Dashboard
Route::get('/admin/capacitor-dashboard', function () {
    return view('admin.capacitor-dashboard');
})->middleware(['auth'])->name('admin.capacitor-dashboard');

// ุฅุฏุงุฑุฉ API Keys
Route::get('/admin/api-keys', function () {
    return view('admin.api-keys');
})->middleware(['auth'])->name('admin.api-keys');

Route::post('/admin/api-keys/generate', function (Request $request) {
    $user = Auth::user();
    $apiKey = $user->generateApiKey();
    
    return response()->json([
        'success' => true,
        'api_key' => $apiKey,
        'expires_at' => $user->api_key_expires_at->format('Y-m-d H:i:s')
    ]);
})->middleware(['auth'])->name('admin.api-keys.generate');
```

---

## ๐ฑ ุจูุงุก ุงูุชุทุจูู

### **1. ุฅุนุฏุงุฏ ุงูุจูุฆุฉ**
```bash
# ุชุซุจูุช Android Studio
# ุชุญููู ูู: https://developer.android.com/studio

# ุชุซุจูุช Xcode (ูููุทูุฑูู)
# ูู App Store

# ุฅุนุฏุงุฏ ูุชุบูุฑุงุช ุงูุจูุฆุฉ
export ANDROID_HOME=$HOME/Android/Sdk
export PATH=$PATH:$ANDROID_HOME/emulator
export PATH=$PATH:$ANDROID_HOME/tools
export PATH=$PATH:$ANDROID_HOME/tools/bin
export PATH=$PATH:$ANDROID_HOME/platform-tools
```

### **2. ุจูุงุก ุงูุชุทุจูู**
```bash
# ุจูุงุก ุงููุดุฑูุน
npm run build

# ูุฒุงููุฉ ูุน Capacitor
npx cap sync

# ุจูุงุก Android
npx cap build android

# ุจูุงุก iOS
npx cap build ios
```

### **3. ุชุดุบูู ุงูุชุทุจูู**
```bash
# ุชุดุบูู ุนูู Android
npx cap run android

# ุชุดุบูู ุนูู iOS
npx cap run ios

# ูุชุญ ูู IDE
npx cap open android
npx cap open ios
```

---

## ๐ง ุงูุชูููู

### **1. ูุชุบูุฑุงุช ุงูุจูุฆุฉ**
```env
# .env
GOOGLE_MAPS_API_KEY=your_google_maps_api_key_here
APP_TIMEZONE=Africa/Cairo
```

### **2. ุฅุนุฏุงุฏุงุช Capacitor**
```json
// capacitor.config.json
{
  "appId": "com.massar.location",
  "appName": "Massar Location Tracker",
  "webDir": "public",
  "server": {
    "androidScheme": "https"
  },
  "plugins": {
    "Geolocation": {
      "enableHighAccuracy": true,
      "timeout": 10000,
      "maximumAge": 0
    },
    "BackgroundMode": {
      "title": "Massar Location Tracker",
      "text": "Tracking your location...",
      "icon": "icon",
      "color": "#000000"
    }
  }
}
```

### **3. ุฅุนุฏุงุฏุงุช Laravel**
```php
// config/services.php
'google' => [
    'maps_api_key' => env('GOOGLE_MAPS_API_KEY'),
],

// config/app.php
'timezone' => env('APP_TIMEZONE', 'Africa/Cairo'),
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### **1. ุงุฎุชุจุงุฑ ุงููุธุงุฆู ุงูุฃุณุงุณูุฉ**
```bash
# ุงุฎุชุจุงุฑ API endpoints
curl -X POST http://localhost:8000/api/location/track \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your_api_key" \
  -d '{
    "latitude": 30.0444,
    "longitude": 31.2357,
    "accuracy": 10,
    "tracked_at": "2025-01-15T10:30:00Z",
    "type": "login"
  }'
```

### **2. ุงุฎุชุจุงุฑ ุงูุชุทุจูู**
```bash
# ุงุฎุชุจุงุฑ ูู ุงููุชุตูุญ
# ุงุฎุชุจุงุฑ ุนูู Android
# ุงุฎุชุจุงุฑ ุนูู iOS
# ุงุฎุชุจุงุฑ ุงูุชุชุจุน ูู ุงูุฎูููุฉ
```

### **3. ุงุฎุชุจุงุฑ ุงูุฃุฏุงุก**
```bash
# ุงุฎุชุจุงุฑ ุงุณุชููุงู ุงูุจุทุงุฑูุฉ
# ุงุฎุชุจุงุฑ ุงุณุชููุงู ุงูุจูุงูุงุช
# ุงุฎุชุจุงุฑ ุฏูุฉ ุงููููุน
```

---

## ๐ ูุฑุงูุจุฉ ุงูุฃุฏุงุก

### **1. ุฅุญุตุงุฆูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช**
```sql
-- ุนุฏุฏ ุงูููุงูุน ุงููุณุฌูุฉ
SELECT COUNT(*) as total_locations FROM user_location_tracking;

-- ุงูููุงูุน ุงูููู
SELECT COUNT(*) as today_locations 
FROM user_location_tracking 
WHERE DATE(tracked_at) = CURDATE();

-- ุงูููุงูุน ููู ูุณุชุฎุฏู
SELECT user_id, COUNT(*) as location_count 
FROM user_location_tracking 
GROUP BY user_id 
ORDER BY location_count DESC;
```

### **2. ูุฑุงูุจุฉ API**
```php
// ุฅุถุงูุฉ middleware ููุฑุงูุจุฉ API
class ApiMonitoringMiddleware
{
    public function handle($request, Closure $next)
    {
        $start = microtime(true);
        
        $response = $next($request);
        
        $duration = microtime(true) - $start;
        
        // ุชุณุฌูู ุงูุฃุฏุงุก
        Log::info('API Performance', [
            'endpoint' => $request->path(),
            'method' => $request->method(),
            'duration' => $duration,
            'status' => $response->getStatusCode()
        ]);
        
        return $response;
    }
}
```

---

## ๐ ุงููุดุฑ

### **1. ุงููุดุฑ ุงููุฌุงูู (APK)**
```bash
# ุจูุงุก APK
npx cap build android

# ุงููุชูุฌุฉ ูู:
# android/app/build/outputs/apk/debug/app-debug.apk

# ุฑูุน ุงูููู ุนูู ูููุนู
# ุงููุณุชุฎุฏููู ูุญููููู ูุจุงุดุฑุฉ
```

### **2. ุงููุดุฑ ุนุจุฑ GitHub Releases**
```bash
# ุฅูุดุงุก tag
git tag v1.0.0
git push origin v1.0.0

# ุฑูุน APK ูู GitHub Releases
# ุฅุถุงูุฉ ุฑุงุจุท ุงูุชุญููู ูู README
```

### **3. ุงููุดุฑ ุนุจุฑ ูุชุงุฌุฑ ุงูุชุทุจููุงุช**
```bash
# Google Play Store ($25)
# Apple App Store ($99/ุณูุฉ)

# ุจูุงุก signed APK/IPA
# ุฑูุน ูููุชุงุฌุฑ
```

---

## ๐ ุงูุฃูุงู

### **1. ุญูุงูุฉ API Keys**
```php
// ุชุดููุฑ API Keys
class User extends Model
{
    protected $casts = [
        'api_key' => 'encrypted',
    ];
}
```

### **2. Rate Limiting**
```php
// ูู routes/api.php
Route::post('/location/track', [LocationController::class, 'storeTracking'])
    ->middleware(['throttle:60,1']); // 60 ุทูุจ ูู ุงูุฏูููุฉ
```

### **3. ุงูุชุญูู ูู ุงูุจูุงูุงุช**
```php
// validation rules
'latitude' => 'required|numeric|between:-90,90',
'longitude' => 'required|numeric|between:-180,180',
'accuracy' => 'nullable|numeric|min:0|max:1000',
```

---

## ๐ ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ

### **1. ุชุญุณููุงุช ุงูุฃุฏุงุก**
- ุงุณุชุฎุฏุงู Web Workers
- ุชุญุณูู ุงุณุชููุงู ุงูุจุทุงุฑูุฉ
- ุถุบุท ุงูุจูุงูุงุช

### **2. ููุฒุงุช ุฅุถุงููุฉ**
- ุฅุดุนุงุฑุงุช ูุญููุฉ
- ุฎุฑุงุฆุท ุชูุงุนููุฉ
- ุชูุงุฑูุฑ ููุตูุฉ

### **3. ุชุญุณููุงุช ุงูุฃูุงู**
- ุชุดููุฑ ุงูุจูุงูุงุช
- ูุตุงุฏูุฉ ูุชูุฏูุฉ
- ูุฑุงูุจุฉ ุงูุฃูุงู

---

## ๐ฏ ุงููุชุงุฆุฌ ุงููุชููุนุฉ

### **1. ุงูุชุชุจุน ุงูุญูููู**
- โ ูุนูู ูู ุงูุฎูููุฉ ุงูุญููููุฉ
- โ ูุนูู ุจุนุฏ ุฅุบูุงู ุงูุชุทุจูู
- โ ูุนูู ุจุนุฏ ุชุณุฌูู ุงูุฎุฑูุฌ
- โ ุชุชุจุน ูุณุชูุฑ ููุฏุฉ 10 ุณุงุนุงุช

### **2. ุงูุฃุฏุงุก**
- โ ุฏูุฉ ุนุงููุฉ ูู ุงููููุน
- โ ุงุณุชููุงู ูุนููู ููุจุทุงุฑูุฉ
- โ ุงุณุชููุงู ูุนููู ููุจูุงูุงุช
- โ ุงุณุชุฌุงุจุฉ ุณุฑูุนุฉ

### **3. ุณูููุฉ ุงูุงุณุชุฎุฏุงู**
- โ ูุงุฌูุฉ ูุณุชุฎุฏู ุจุณูุทุฉ
- โ ุฅุนุฏุงุฏุงุช ุณููุฉ
- โ ุชูุงุฑูุฑ ูุงุถุญุฉ
- โ ุฏุนู ูุชุนุฏุฏ ุงูููุตุงุช

---

## ๐ ููุงุญุธุงุช ูููุฉ

### **1. ุงููุชุทูุจุงุช**
- Node.js 16+
- Android Studio
- Xcode (ูููุทูุฑูู)
- Laravel 12

### **2. ุงูุชูุงููู**
- **ุงูุชุทููุฑ**: ูุฌุงูู 100%
- **ุงููุดุฑ ุงููุจุงุดุฑ**: ูุฌุงูู 100%
- **ูุชุงุฌุฑ ุงูุชุทุจููุงุช**: ุงุฎุชูุงุฑู ($25-99)

### **3. ุงูุฏุนู**
- ุชูุซูู Capacitor ููุชุงุฒ
- ูุฌุชูุน ูุดุท
- ุชุญุฏูุซุงุช ููุชุธูุฉ

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

### **1. ุงูุจุฏุก ุงูููุฑู**
```bash
# ุชุซุจูุช Capacitor
npm install @capacitor/core @capacitor/cli

# ุชููุฆุฉ ุงููุดุฑูุน
npx cap init "Massar Location Tracker" "com.massar.location"
```

### **2. ุงูุชุทููุฑ ุงูุชุฏุฑูุฌู**
- ุงุจุฏุฃ ุจุงููุธุงุฆู ุงูุฃุณุงุณูุฉ
- ุงุฎุชุจุฑ ุนูู ูู ูุฑุญูุฉ
- ุฃุถู ุงูููุฒุงุช ุชุฏุฑูุฌูุงู

### **3. ุงููุดุฑ ุงูุชุฏุฑูุฌู**
- ุงุจุฏุฃ ุจุงููุดุฑ ุงููุจุงุดุฑ
- ุงุฎุชุจุฑ ูุน ุงููุณุชุฎุฏููู
- ููุฑ ูู ุงููุชุงุฌุฑ ูุงุญูุงู

---

**ุชุงุฑูุฎ ุงูุฅูุดุงุก**: 15 ููุงูุฑ 2025  
**ุงูุฅุตุฏุงุฑ**: 1.0  
**ุงููุทูุฑ**: ูุฑูู ุชุทููุฑ Massar ERP  
**ุงูุญุงูุฉ**: ุฌุงูุฒ ููุชุทุจูู
