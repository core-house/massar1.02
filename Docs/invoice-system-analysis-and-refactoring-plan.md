---
name: Invoice System Analysis and Refactoring
overview: "تحليل شامل لنظام الفواتير وتنظيمه: توحيد Alpine.js scripts في component واحد، إزالة الكود غير المستخدم، تنظيم الملفات، وتحسين البنية."
todos:
  - id: move-calculations-to-alpine
    content: نقل جميع الحسابات (subtotal, discount, additional, total, balance) إلى Alpine.js component
    status: pending
  - id: remove-wire-model-from-calculations
    content: إزالة wire:model من الحقول الحسابية (quantity, price, discount, sub_value) واستبدالها بـ x-model مع إضافة @input handlers و @keydown.enter للتنقل
    status: pending
  - id: improve-search-interactions
    content: تحسين تفاعلات البحث (ArrowUp/Down للتنقل، Enter للإضافة، Escape للإغلاق) في invoiceSearch component
    status: pending
  - id: add-editable-fields-order-method
    content: إضافة getEditableFieldsOrder() method في Livewire للحصول على ترتيب الحقول القابلة للتحرير ديناميكياً من template
    status: pending
  - id: improve-field-navigation
    content: تحسين moveToNextField() في invoiceCalculations component لاستخدام ترتيب الحقول الديناميكي من template مع دعم الأسهم
    status: pending
  - id: implement-calculations-logic
    content: تنفيذ منطق الحسابات (sub_value = quantity × price - discount، تغيير sub_value يغير quantity، حساب الإجماليات)
    status: pending
  - id: remove-updated-methods
    content: إزالة updated methods من Livewire (updatedDiscountPercentage, updatedDiscountValue, etc.)
    status: pending
  - id: add-sync-from-alpine
    content: إضافة syncFromAlpine() method في Livewire و syncToLivewire() في Alpine.js
    status: pending
  - id: create-scripts-component
    content: إنشاء component جديد invoice-scripts.blade.php وتوحيد جميع Alpine.js scripts فيه
    status: pending
  - id: clean-create-form
    content: "تنظيف CreateInvoiceForm.php: حذف properties وmethods غير مستخدمة والكود المعلق"
    status: pending
  - id: clean-edit-form
    content: "تنظيف EditInvoiceForm.php: حذف methods غير مستخدمة والكود المعلق"
    status: pending
  - id: update-blade-views
    content: تحديث invoice-item-table.blade.php و invoice-footer.blade.php لإزالة wire:model من الحقول الحسابية
    status: pending
  - id: test-performance
    content: اختبار الأداء ومراقبة عدد الطلبات في Network tab (يجب أن يكون أقل بكثير)
    status: pending
  - id: test-invoice-flow
    content: اختبار كامل لإنشاء وتعديل الفواتير مع جميع الأنواع
    status: pending
---

# خطة تحليل وتنظيم نظام الفواتير

## 1. تحليل البنية الحالية

### 1.1 هيكل الملفات

- **Livewire Components:**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `app/Livewire/CreateInvoiceForm.php` (1918 سطر)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `app/Livewire/EditInvoiceForm.php` (1238 سطر)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `app/Livewire/Traits/HandlesInvoiceData.php` (586 سطر)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `app/Livewire/Traits/HandlesExpiryDates.php` (يحتاج قراءة)

- **Blade Views:**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `resources/views/livewire/invoices/create-invoice-form.blade.php` (~1840 سطر)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `resources/views/livewire/invoices/edit-invoice-form.blade.php` (~200 سطر)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `resources/views/components/invoices/invoice-head.blade.php`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `resources/views/components/invoices/invoice-footer.blade.php` (381 سطر)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `resources/views/components/invoices/invoice-item-table.blade.php`

### 1.2 تقسيم المسؤوليات (Livewire vs Alpine)

#### Livewire (Server-side):

- **CreateInvoiceForm:**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `searchItems()` - البحث عن الأصناف
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `addItemFromSearchFast()` - إضافة صنف للفاتورة
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `getItemForInvoice()` - جلب بيانات صنف
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `calculateTotals()` - حساب الإجماليات
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `saveForm()` - حفظ الفاتورة
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `createNewItem()` - إنشاء صنف جديد
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `updatePriceForUnit()` - تحديث السعر عند تغيير الوحدة
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `recalculateSubValues()` - إعادة حساب القيم الفرعية
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `calculateBalanceAfterInvoice()` - حساب الرصيد بعد الفاتورة

- **EditInvoiceForm:**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `updateForm()` - تحديث الفاتورة
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `loadInvoiceItems()` - تحميل أصناف الفاتورة
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - نفس الدوال الحسابية مثل CreateInvoiceForm

- **HandlesInvoiceData Trait:**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `initializeInvoice()` - تهيئة الفاتورة
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `loadBranchFilteredData()` - تحميل البيانات حسب الفرع
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `calculateItemPrice()` - حساب سعر الصنف
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `getAccountBalance()` - جلب رصيد الحساب

#### Alpine.js (Client-side):

- **invoiceSearch Component:**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - البحث عن الأصناف (debounced)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - عرض نتائج البحث
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - التنقل بالكيبورد (Arrow keys, Enter)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - إضافة صنف من نتائج البحث
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - إنشاء صنف جديد

- **invoiceCalculations Component:**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - حساب القيم الفرعية (sub_value) لكل صف
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - حساب الإجماليات (subtotal, discount, additional, total)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - حساب الباقي (remaining)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - مزامنة القيم مع Livewire
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - حساب الكمية من الأبعاد (dimensions)

### 1.3 Workflow Structure

#### إنشاء فاتورة جديدة:

1. **Mount:** `CreateInvoiceForm::mount()` → `initializeInvoice()`
2. **Load Data:** `loadBranchFilteredData()` → تحميل الحسابات، الأصناف، الموظفين
3. **User Interaction:**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - البحث عن صنف (Alpine.js `invoiceSearch`)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - إضافة صنف (Livewire `addItemFromSearchFast`)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - تعديل الكمية/السعر (Alpine.js calculations + Livewire sync)

4. **Save:** `saveForm()` → `SaveInvoiceService::saveInvoice()`

#### تعديل فاتورة:

1. **Mount:** `EditInvoiceForm::mount()` → تحميل الفاتورة من DB
2. **Load Items:** `loadInvoiceItems()` → تحويل OperationItems إلى array
3. **User Interaction:** نفس إنشاء فاتورة
4. **Update:** `updateForm()` → `SaveInvoiceService::saveInvoice($this, true)`

### 1.4 Business Logic Structure

#### حساب السعر (`calculateItemPrice`):

- فواتير المشتريات (11, 15): آخر سعر شراء أو التكلفة المتوسطة
- فواتير التوالف (18): التكلفة المتوسطة
- فواتير المبيعات (10): سعر البيع + اتفاقيات التسعير/آخر سعر للعميل
- اتفاقيات التسعير (26): آخر سعر من اتفاقية

#### حساب الرصيد (`calculateBalanceAfterInvoice`):

- فاتورة مبيعات (10): يزيد الرصيد بالباقي (مديونية العميل)
- فاتورة مشتريات (11): يقل الرصيد بالمستحق (مديونيتك للمورد)
- مردود مبيعات (12): يقل المديونية
- مردود مشتريات (13): يزيد الرصيد

### 1.5 UI Structure

#### Components Hierarchy:

```
create-invoice-form.blade.php
├── invoice-head.blade.php (رأس الفاتورة: الحسابات، التواريخ)
├── invoice-item-table.blade.php (جدول الأصناف)
└── invoice-footer.blade.php (التذييل: الإجماليات، الأزرار)
```

#### Alpine.js Components:

- `invoiceSearch` - في `create-invoice-form.blade.php` (inline)
- `invoiceCalculations` - في `create-invoice-form.blade.php` و `edit-invoice-form.blade.php` (مكرر)

## 2. المشاكل والتناقضات

### 2.1 كود مكرر:

- Alpine.js `invoiceCalculations` موجود في كلا الملفين (create + edit)
- بعض الدوال موجودة في CreateInvoiceForm و EditInvoiceForm مع اختلافات بسيطة
- `calculateTotals()`, `recalculateSubValues()` موجودة في كلا الملفين

### 2.2 كود غير مستخدم:

- `CreateInvoiceForm`:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `$barcodeSearchResults` - معلق في الكود أنه تم نقله لـ Alpine
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `$selectedBarcodeResultIndex` - نفس الشيء
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `updatedBarcodeTerm()` - method فارغة (سطر 674)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `checkSearchResults()` - method فارغة (سطر 1874)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - كود معلق في `updatedInvoiceItems()` (سطور 1347-1363)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `addRecommendedItem()` - method معلقة (سطور 522-545)

- `EditInvoiceForm`:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `updatedBarcodeTerm()` - method معلقة (سطور 573-577)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `handleKeyDown()`, `handleKeyUp()`, `handleEnter()` - موجودة لكن قد لا تُستخدم

### 2.3 Scripts مبعثرة:

- Alpine.js components في `@push('scripts')` في `create-invoice-form.blade.php`
- Alpine.js components في `edit-invoice-form.blade.php` (مكرر)
- Event listeners مبعثرة في نهاية `create-invoice-form.blade.php`

### 2.4 مسؤوليات مختلطة:

- UI state في Livewire properties (مثل `$barcodeSearchResults`, `$selectedResultIndex`)
- بعض الحسابات في Livewire يمكن نقلها لـ Alpine.js للسرعة

## 3. الحل المقترح - تحسين الأداء وتقليل الطلبات

### 🎯 الهدف الرئيسي: تقليل عدد الطلبات على السيرفر إلى أقل شيء ممكن

### 3.1 استراتيجية المزامنة (Sync Strategy)

#### ✅ مزامنة مع Livewire فقط عند:

- **الحفظ** (`saveForm()` / `updateForm()`)
- **تغيير الفرع** (`branch_id`)
- **تغيير العميل/المورد** (`acc1_id`)
- **تغيير الصندوق** (`cash_box_id`)
- **تغيير الحسابات عموماً**
- **تغيير المخازن** (`acc2_id`)

#### ✅ باقي التفاعلات في Alpine.js فقط (بدون مزامنة):

- تعديل الكمية (`quantity`)
- تعديل السعر (`price`)
- تعديل الخصم (`discount`)
- تعديل القيمة الفرعية (`sub_value`)
- حساب الإجماليات (`subtotal`, `discount_value`, `additional_value`, `total_after_additional`)
- حساب الباقي (`remaining`)
- حساب الرصيد بعد الفاتورة (`balanceAfterInvoice`)

### 3.2 إنشاء Alpine.js Component منفصل

**ملف جديد:** `resources/views/components/invoices/invoice-scripts.blade.php`

**المحتوى:**

- `invoiceSearch` component (البحث عن الأصناف)
- `invoiceCalculations` component (جميع الحسابات client-side)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - حساب القيم الفرعية (`sub_value`)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - حساب الإجماليات (`subtotal`, `discount`, `additional`, `total`)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - حساب الباقي (`remaining`)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - حساب الرصيد بعد الفاتورة (`balanceAfterInvoice`)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - حساب الكمية من الأبعاد (`dimensions`)
- Alpine stores (`invoiceNavigation`, `invoiceCalculations`)
- Event listeners المشتركة
- `syncToLivewire()` method - يتم استدعاؤها فقط عند الحفظ أو تغيير الحسابات المهمة

**الاستخدام:**

```blade
@include('components.invoices.invoice-scripts')
```

### 3.3 إزالة wire:model من الحقول الحسابية

#### في `invoice-item-table.blade.php`:

**قبل:**

```blade
<input wire:model="invoiceItems.{{ $index }}.quantity" />
<input wire:model="invoiceItems.{{ $index }}.price" />
<input wire:model="invoiceItems.{{ $index }}.discount" />
```

**بعد:**

```blade
<input x-model="invoiceItems[{{ $index }}].quantity" 
       @input="updateRowCalculations({{ $index }})" />
<input x-model="invoiceItems[{{ $index }}].price" 
       @input="updateRowCalculations({{ $index }})" />
<input x-model="invoiceItems[{{ $index }}].discount" 
       @input="updateRowCalculations({{ $index }})" />
```

#### في `invoice-footer.blade.php`:

**قبل:**

```blade
<input wire:model.live="discount_percentage" />
<input wire:model.live="discount_value" />
```

**بعد:**

```blade
<input x-model="discountPercentage" 
       @input="updateDiscountFromPercentage()" />
<input x-model="discountValue" 
       @input="updateDiscountFromValue()" />
```

### 3.4 إضافة method للحصول على ترتيب الحقول الديناميكي

#### في `CreateInvoiceForm.php` و `EditInvoiceForm.php`:

**إضافة method جديد:**

```php
/**
 * الحصول على ترتيب الحقول القابلة للتحرير حسب template
 * يعيد array من الحقول مرتبة حسب template مع فلترة الحقول المخفية وغير القابلة للتحرير
 */
public function getEditableFieldsOrder(): array
{
    if (!$this->currentTemplate) {
        // ترتيب افتراضي إذا لم يكن هناك template
        return ['unit', 'quantity', 'price', 'discount', 'sub_value'];
    }
    
    $orderedColumns = $this->currentTemplate->getOrderedColumns();
    $editableFields = [
        'unit', 'quantity', 'batch_number', 'expiry_date',
        'length', 'width', 'height', 'density',
        'price', 'discount', 'sub_value'
    ];
    
    // فلترة: فقط الحقول القابلة للتحرير والمرئية
    $result = [];
    foreach ($orderedColumns as $columnKey) {
        if (in_array($columnKey, $editableFields) && $this->shouldShowColumn($columnKey)) {
            $result[] = $columnKey;
        }
    }
    
    return $result;
}
```

**الاستخدام:**

- يتم استدعاؤها من Alpine.js عند `init()`: `$wire.getEditableFieldsOrder()`
- يتم استدعاؤها عند تغيير template لإعادة تحميل الترتيب

### 3.5 إزالة/تقليل updated methods في Livewire

#### في `CreateInvoiceForm.php`:

**إزالة بالكامل:**

- `updatedDiscountPercentage()` - نقل لـ Alpine.js
- `updatedDiscountValue()` - نقل لـ Alpine.js
- `updatedAdditionalPercentage()` - نقل لـ Alpine.js
- `updatedAdditionalValue()` - نقل لـ Alpine.js
- `recalculateSubValues()` - نقل لـ Alpine.js
- `calculateTotals()` - نقل لـ Alpine.js
- `calculateBalanceAfterInvoice()` - نقل لـ Alpine.js

**تبسيط `updatedInvoiceItems()`:**

- إزالة جميع الحسابات
- الإبقاء فقط على:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - فحص الرصيد عند تغيير الكمية (عند الحاجة)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - التحقق من صلاحيات المستخدم
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - التحقق من صحة البيانات (negative values, etc.)

**إبقاء `updated` methods فقط لـ:**

- `updatedAcc1Id()` - يحتاج مزامنة (تحديث الرصيد، التوصيات)
- `updatedAcc2Id()` - يحتاج مزامنة (تحديث الرصيد المتاح)
- `updatedBranchId()` - يحتاج مزامنة (تحديث القوائم)
- `updatedSelectedPriceType()` - يحتاج مزامنة (تحديث الأسعار)

#### في `EditInvoiceForm.php`:

- نفس التغييرات مثل `CreateInvoiceForm`

### 3.6 إضافة method لمزامنة البيانات عند الحفظ

#### في `CreateInvoiceForm.php` و `EditInvoiceForm.php`:

```php
/**
 * مزامنة البيانات من Alpine.js إلى Livewire قبل الحفظ
 */
public function syncFromAlpine(array $alpineData): void
{
    // مزامنة الأصناف
    if (isset($alpineData['invoiceItems'])) {
        $this->invoiceItems = $alpineData['invoiceItems'];
    }
    
    // مزامنة الإجماليات
    $this->subtotal = $alpineData['subtotal'] ?? 0;
    $this->discount_percentage = $alpineData['discountPercentage'] ?? 0;
    $this->discount_value = $alpineData['discountValue'] ?? 0;
    $this->additional_percentage = $alpineData['additionalPercentage'] ?? 0;
    $this->additional_value = $alpineData['additionalValue'] ?? 0;
    $this->total_after_additional = $alpineData['totalAfterAdditional'] ?? 0;
    $this->received_from_client = $alpineData['receivedFromClient'] ?? 0;
    
    // إعادة حساب الرصيد (server-side validation)
    if ($this->showBalance && $this->acc1_id) {
        $this->currentBalance = $this->getAccountBalance($this->acc1_id);
        $this->calculateBalanceAfterInvoice();
    }
}

public function saveForm()
{
    // مزامنة البيانات من Alpine.js قبل الحفظ
    $this->syncFromAlpine($this->getAlpineData());
    
    // باقي منطق الحفظ...
    $service = new SaveInvoiceService();
    return $service->saveInvoice($this);
}
```

#### في Alpine.js component:

```javascript
syncToLivewire() {
    // يتم استدعاؤها فقط عند الحفظ أو تغيير الحسابات المهمة
    if (typeof this.$wire !== 'undefined') {
        this.$wire.call('syncFromAlpine', {
            invoiceItems: this.invoiceItems,
            subtotal: this.subtotal,
            discountPercentage: this.discountPercentage,
            discountValue: this.discountValue,
            additionalPercentage: this.additionalPercentage,
            additionalValue: this.additionalValue,
            totalAfterAdditional: this.totalAfterAdditional,
            receivedFromClient: this.receivedFromClient
        });
    }
}
```

### 3.8 تنظيف الكود غير المستخدم

#### 3.6.1 البحث عن الأصناف:

**الوظائف:**

- `search()` - البحث debounced (300ms) → استدعاء Livewire `searchItems()`
- `selectNext()` - ArrowDown → الانتقال للعنصر التالي
- `selectPrevious()` - ArrowUp → الانتقال للعنصر السابق
- `addSelectedItem()` - Enter → إضافة الصنف المحدد
- `clearSearch()` - Escape → إغلاق النتائج

**الطلبات:**

- 1 request عند البحث (debounced 300ms)
- 1 request عند إضافة الصنف

#### 3.6.2 التنقل بين حقول الصنف (ديناميكي بناءً على Template):

**الحقول القابلة للتحرير (Editable Fields):**

- `unit` (select - الوحدة)
- `quantity` (input - الكمية)
- `batch_number` (input/select - رقم الدفعة)
- `expiry_date` (input date - تاريخ الصلاحية)
- `length`, `width`, `height`, `density` (inputs - الأبعاد)
- `price` (input - السعر)
- `discount` (input - الخصم)
- `sub_value` (input - الإجمالي)

**الحقول غير القابلة للتحرير (Non-editable):**

- `item_name` (span - اسم الصنف)
- `item_code` (span - كود الصنف)

**المنطق الديناميكي:**

1. **الحصول على ترتيب الأعمدة من Template:**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `$this->currentTemplate->getOrderedColumns()` - يعيد ترتيب الأعمدة
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `$this->shouldShowColumn($columnKey)` - يتحقق من ظهور العمود

2. **فلترة الحقول القابلة للتحرير:**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - استخراج فقط الحقول القابلة للتحرير من ترتيب template
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - تخطي الحقول غير القابلة للتحرير (`item_name`, `item_code`)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - تخطي الحقول المخفية (التي لا يظهرها template)

3. **الوظائف المطلوبة:**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `getEditableFieldsOrder()` - method في Livewire يعيد ترتيب الحقول القابلة للتحرير
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `moveToNextField(event)` - في Alpine.js:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - تحديد الحقل الحالي من `event.target.id`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - استخراج `columnKey` و `rowIndex` من ID
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - الحصول على ترتيب الحقول من Livewire (أو من DOM)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - العثور على الحقل التالي في نفس الصف
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - إذا لم يوجد، الانتقال للصف التالي (من أول حقل)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - إذا لم يوجد صف تالي، العودة لحقل البحث

**الوظائف:**

- `moveToNextField(event)` - Enter → الانتقال للحقل التالي (ديناميكي)
- دعم ArrowLeft/ArrowRight للتنقل بين الحقول
- دعم ArrowUp/ArrowDown للتنقل بين الصفوف

**الطلبات:**

- 0 requests (Alpine.js فقط)
- ترتيب الحقول يتم تحديده من template عند التحميل

#### 3.6.3 تفاعلات حساب الأرقام:

**القواعد:**

1. **السعر × الكمية = الإجمالي:**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `sub_value = (quantity × price) - discount`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - يتم حسابها تلقائياً عند تغيير `quantity` أو `price` أو `discount`

2. **تغيير الإجمالي يغير الكمية:**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - إذا تم تغيير `sub_value` مباشرة:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `quantity = (sub_value + discount) / price`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - السعر يبقى كما هو

3. **مجموع الإجمالي الفرعي:**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `subtotal = sum(all sub_value)`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - يتم تحديثه تلقائياً عند تغيير أي `sub_value`

4. **المجموع الإجمالي بعد الإضافي والخصم:**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `discountValue = (subtotal × discountPercentage) / 100`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `additionalValue = ((subtotal - discountValue) × additionalPercentage) / 100`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `totalAfterAdditional = subtotal - discountValue + additionalValue`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `remaining = totalAfterAdditional - receivedFromClient`

**الوظائف:**

- `updateRowCalculations(index)` - تحديث `sub_value` للصف
- `handleSubValueChange(index)` - معالجة تغيير `sub_value` مباشرة
- `updateDisplays()` - تحديث جميع الإجماليات
- `updateDiscountFromPercentage()` - تحديث `discountValue` من النسبة
- `updateDiscountFromValue()` - تحديث `discountPercentage` من القيمة
- `updateAdditionalFromPercentage()` - تحديث `additionalValue` من النسبة
- `updateAdditionalFromValue()` - تحديث `additionalPercentage` من القيمة

**الطلبات:**

- 0 requests (Alpine.js فقط)
- مزامنة مع Livewire فقط عند الحفظ

### 3.7 تنظيف الكود غير المستخدم

#### في `CreateInvoiceForm.php`:

- حذف `$barcodeSearchResults` و `$selectedBarcodeResultIndex` (نقل لـ Alpine)
- حذف `updatedBarcodeTerm()` (method فارغة)
- حذف `checkSearchResults()` (method فارغة)
- حذف `addRecommendedItem()` (method معلقة)
- حذف `recalculateSubValues()`, `calculateTotals()`, `calculateBalanceAfterInvoice()` (نقل لـ Alpine)
- تنظيف الكود المعلق في `updatedInvoiceItems()`

#### في `EditInvoiceForm.php`:

- نفس التغييرات مثل `CreateInvoiceForm`

### 3.7 تنظيم الملفات

#### هيكل مقترح:

```
app/Livewire/
├── CreateInvoiceForm.php (مبسط - يستخدم Traits)
├── EditInvoiceForm.php (مبسط - يستخدم Traits)
└── Traits/
    ├── HandlesInvoiceData.php (محسّن)
    ├── HandlesExpiryDates.php
    └── HandlesInvoiceCalculations.php (جديد - للحسابات المشتركة)

resources/views/
├── livewire/invoices/
│   ├── create-invoice-form.blade.php (مبسط)
│   └── edit-invoice-form.blade.php (مبسط)
└── components/invoices/
    ├── invoice-head.blade.php
    ├── invoice-footer.blade.php
    ├── invoice-item-table.blade.php
    └── invoice-scripts.blade.php (جديد - جميع Alpine.js scripts)
```

## 4. خطوات التنفيذ - محسّنة لتقليل الطلبات

### المرحلة 1: نقل جميع الحسابات إلى Alpine.js

1. **تحديث `invoiceCalculations` component:**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - نقل `calculateSubValue()` - حساب القيمة الفرعية لكل صف
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - نقل `calculateTotals()` - حساب الإجماليات (subtotal, discount, additional, total)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - نقل `calculateBalanceAfterInvoice()` - حساب الرصيد بعد الفاتورة
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - نقل `calculateQuantityFromDimensions()` - حساب الكمية من الأبعاد
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - نقل `updateDiscountFromPercentage()` و `updateDiscountFromValue()`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - نقل `updateAdditionalFromPercentage()` و `updateAdditionalFromValue()`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - إزالة جميع استدعاءات `$wire.set()` من الحسابات

2. **إضافة `syncToLivewire()` method:**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - يتم استدعاؤها فقط عند الحفظ (`@submit="syncToLivewire()"`)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - يتم استدعاؤها عند تغيير الحسابات المهمة (`acc1_id`, `acc2_id`, `branch_id`)

### المرحلة 2: إزالة wire:model من الحقول الحسابية

1. **تحديث `invoice-item-table.blade.php`:**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - استبدال `wire:model` بـ `x-model` للحقول: `quantity`, `price`, `discount`, `sub_value`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - إضافة `@input` handlers لاستدعاء `updateRowCalculations()` في Alpine
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - إزالة `wire:model.blur` من الحقول الحسابية

2. **تحديث `invoice-footer.blade.php`:**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - استبدال `wire:model.live` بـ `x-model` للحقول: `discount_percentage`, `discount_value`, `additional_percentage`, `additional_value`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - إضافة `@input` handlers لاستدعاء دوال Alpine

3. **إبقاء `wire:model` فقط لـ:**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `acc1_id`, `acc2_id`, `branch_id`, `cash_box_id`, `emp_id`, `pro_date`, `accural_date`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `selectedTemplateId`, `selectedPriceType`, `status`

### المرحلة 2.6: إضافة method للحصول على ترتيب الحقول

1. **في `CreateInvoiceForm.php` و `EditInvoiceForm.php`:**

                                                                                                                                                                                                - إضافة `getEditableFieldsOrder()` method
                                                                                                                                                                                                - يعيد array من الحقول القابلة للتحرير مرتبة حسب template
                                                                                                                                                                                                - يفلتر الحقول بناءً على `shouldShowColumn()` و `getOrderedColumns()`
                                                                                                                                                                                                - يتخطى الحقول غير القابلة للتحرير

2. **في `invoiceCalculations` component:**

                                                                                                                                                                                                - الحصول على ترتيب الحقول من Livewire عند `init()`
                                                                                                                                                                                                - حفظ الترتيب في `editableFieldsOrder` property
                                                                                                                                                                                                - الاستماع لتغيير template وإعادة تحميل الترتيب

### المرحلة 3: إزالة updated methods من Livewire

1. **في `CreateInvoiceForm.php`:**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - حذف `updatedDiscountPercentage()`, `updatedDiscountValue()`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - حذف `updatedAdditionalPercentage()`, `updatedAdditionalValue()`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - حذف `recalculateSubValues()`, `calculateTotals()`, `calculateBalanceAfterInvoice()`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - تبسيط `updatedInvoiceItems()` - إزالة جميع الحسابات، الإبقاء فقط على التحقق من الرصيد والصلاحيات

2. **في `EditInvoiceForm.php`:**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - نفس التغييرات

3. **إضافة `syncFromAlpine()` method:**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - في `CreateInvoiceForm` و `EditInvoiceForm`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - يتم استدعاؤها من `saveForm()` و `updateForm()` قبل الحفظ

### المرحلة 4: إنشاء Component للـ Scripts

1. إنشاء `resources/views/components/invoices/invoice-scripts.blade.php`
2. نقل جميع Alpine.js components من `create-invoice-form.blade.php`
3. نقل Alpine.js components من `edit-invoice-form.blade.php` (دمج المكرر)
4. نقل Event listeners المشتركة
5. إضافة `@include('components.invoices.invoice-scripts')` في create و edit

### المرحلة 5: تنظيف الكود غير المستخدم

1. حذف properties غير مستخدمة من `CreateInvoiceForm`:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `$barcodeSearchResults`, `$selectedBarcodeResultIndex`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `$isCreateNewItemSelected`, `$selectedResultIndex`

2. حذف methods غير مستخدمة:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - `updatedBarcodeTerm()`, `checkSearchResults()`, `addRecommendedItem()`

3. حذف الكود المعلق

### المرحلة 6: تحسين البنية

1. مراجعة `HandlesInvoiceData` - إزالة التكرار
2. تحسين `calculateItemPrice()` - تبسيط المنطق
3. توحيد طريقة معالجة الأخطاء
4. إضافة PHPDoc comments للتوثيق

## 5. ملفات تحتاج تعديل

### ملفات جديدة:

- `resources/views/components/invoices/invoice-scripts.blade.php`
- `app/Livewire/Traits/HandlesInvoiceCalculations.php`

### ملفات تحتاج تعديل:

- `app/Livewire/CreateInvoiceForm.php` (تنظيف + استخدام Traits)
- `app/Livewire/EditInvoiceForm.php` (تنظيف + استخدام Traits)
- `app/Livewire/Traits/HandlesInvoiceData.php` (تحسين)
- `resources/views/livewire/invoices/create-invoice-form.blade.php` (إزالة scripts + include)
- `resources/views/livewire/invoices/edit-invoice-form.blade.php` (إزالة scripts + include)

## 6. التحسينات المتوقعة

### 6.1 تقليل عدد الطلبات

**قبل التحسين:**

- كل تعديل في الكمية/السعر/الخصم = 1 request
- كل تعديل في الخصم/الإضافي = 1 request
- كل حساب للإجماليات = 1 request
- **المجموع:** ~50-100+ request أثناء إنشاء فاتورة واحدة

**بعد التحسين:**

- تعديلات الكمية/السعر/الخصم = 0 requests (Alpine.js فقط)
- تعديلات الخصم/الإضافي = 0 requests (Alpine.js فقط)
- حساب الإجماليات = 0 requests (Alpine.js فقط)
- **المجموع:** ~5-10 requests فقط (عند الحفظ + تغيير الحسابات المهمة)

### 6.2 تحسين تجربة المستخدم

- **سرعة:** الحسابات فورية بدون انتظار السيرفر
- **سلاسة:** لا يوجد lag عند الكتابة
- **استجابة:** UI يتفاعل فوراً مع التغييرات

### 6.3 تقليل الحمل على السيرفر

- تقليل عدد الطلبات بنسبة ~80-90%
- تقليل استهلاك الذاكرة (لا حاجة لحفظ state في Livewire)
- تحسين الأداء العام للتطبيق

## 7. اختبارات مطلوبة

### 7.1 اختبارات الوظائف الأساسية

1. ✅ اختبار إنشاء فاتورة جديدة
2. ✅ اختبار تعديل فاتورة موجودة
3. ✅ اختبار البحث عن أصناف
4. ✅ اختبار إضافة أصناف
5. ✅ اختبار الحسابات (الإجماليات، الخصومات) - يجب أن تكون فورية
6. ✅ اختبار التنقل بالكيبورد
7. ✅ اختبار حفظ الفاتورة - يجب أن يتم المزامنة قبل الحفظ

### 7.2 اختبارات المزامنة

1. ✅ اختبار تغيير الفرع - يجب أن يتم المزامنة
2. ✅ اختبار تغيير العميل/المورد - يجب أن يتم المزامنة
3. ✅ اختبار تغيير المخزن - يجب أن يتم المزامنة
4. ✅ اختبار تغيير الصندوق - يجب أن يتم المزامنة
5. ✅ اختبار تعديل الكمية/السعر/الخصم - يجب ألا يتم المزامنة حتى الحفظ

### 7.3 اختبارات الأداء

1. ✅ مراقبة عدد الطلبات في Network tab (يجب أن يكون أقل بكثير)
2. ✅ اختبار سرعة الحسابات (يجب أن تكون فورية)
3. ✅ اختبار استجابة UI (يجب ألا يكون هناك lag)

### 7.4 اختبارات جميع أنواع الفواتير

1. ✅ فاتورة مبيعات (10)
2. ✅ فاتورة مشتريات (11)
3. ✅ مردود مبيعات (12)
4. ✅ مردود مشتريات (13)
5. ✅ أمر بيع (14)
6. ✅ أمر شراء (15)
7. ✅ عرض سعر لعميل (16)
8. ✅ عرض سعر من مورد (17)
9. ✅ فاتورة توالف (18)
10. ✅ أمر صرف (19)
11. ✅ أمر إضافة (20)
12. ✅ تحويل من مخزن لمخزن (21)
13. ✅ أمر حجز (22)
14. ✅ فاتورة خدمات (24)
15. ✅ طلب احتياج (25)
16. ✅ اتفاقية تسعير (26)