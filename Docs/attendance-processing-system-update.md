# نظام معالجة الحضور المحدث - التوثيق

## نظرة عامة
تم تحديث نظام معالجة الحضور في Laravel ليتوافق مع هيكل قاعدة البيانات المطلوب ووظائف المعالجة المتقدمة. يدعم النظام الآن معالجة الحضور للموظفين الفرديين والمتعددين والأقسام الكاملة مع حساب الرواتب التلقائي.

## الميزات الرئيسية

### 1. أنواع المعالجة
- **موظف واحد**: معالجة حضور موظف محدد
- **عدة موظفين**: معالجة حضور مجموعة من الموظفين المختارين
- **قسم كامل**: معالجة حضور جميع موظفي قسم معين

### 2. تتبع مفصل للحضور
- تسجيل أوقات الدخول والخروج الفعلية
- حساب ساعات العمل الأساسية والإضافية
- تتبع ساعات التأخير والخروج المبكر
- تحديد نوع اليوم (عمل عادي / إضافي / إجازة أسبوعية)

### 3. حساب الرواتب
- حساب الراتب الأساسي بناءً على ساعات العمل
- حساب راتب الساعات الإضافية مع معاملات مختلفة
- دعم أنواع رواتب متعددة
- حفظ تفاصيل الحساب لكل يوم

## هيكل قاعدة البيانات

### جدول `attendance_processings` (الملخص)
```sql
- id: مفتاح أساسي
- type: نوع المعالجة (single/multiple/department)
- employee_id: معرف الموظف (للمعالجة الفردية)
- department_id: معرف القسم
- period_start/period_end: فترة المعالجة
- total_days: إجمالي الأيام
- working_days: أيام العمل المتوقعة
- actual_work_days: أيام العمل الفعلية
- overtime_work_days: أيام العمل الإضافية
- absent_days: أيام الغياب
- total_hours: إجمالي الساعات المتوقعة
- actual_work_hours: ساعات العمل الفعلية
- overtime_work_hours: ساعات العمل الإضافية
- calculated_salary_for_day/hour: معدلات الراتب اليومية والساعية
- employee_productivity_salary: راتب الإنتاجية
- salary_due: الراتب المستحق
- total_salary: إجمالي الراتب
- status: حالة المعالجة (pending/approved/rejected)
```

### جدول `attendance_processing_details` (التفاصيل اليومية)
```sql
- id: مفتاح أساسي
- attendance_processing_id: مرجع لجدول المعالجات
- employee_id: معرف الموظف
- department_id: معرف القسم
- attendance_date: تاريخ الحضور
- attendance_status: حالة الحضور (حضور/غياب/إجازة/إذن)
- shift_start_time/shift_end_time: أوقات المناوبة
- working_hours_in_shift: ساعات العمل في المناوبة
- check_in_time/check_out_time: أوقات الدخول والخروج الفعلية
- attendance_basic_hours_count: ساعات العمل الأساسية
- attendance_actual_hours_count: ساعات العمل الفعلية
- attendance_overtime_hours_count: ساعات العمل الإضافية
- attendance_late_hours_count: ساعات التأخير
- early_hours: ساعات الخروج المبكر
- attendance_total_hours_count: إجمالي ساعات العمل
- total_due_hourly_salary: الراتب المستحق لهذا اليوم
- is_working_day: هل هو يوم عمل
- is_overtime_day: هل هو يوم عمل إضافي
```

## الملفات المحدثة

### 1. ملفات الهجرة (Migrations)
- `2025_07_02_170527_create_attendance_processings_table.php`
- `2025_07_02_192318_create_attendance_processing_details_table.php`

### 2. النماذج (Models)
- `AttendanceProcessing.php`: محدث مع العلاقات والخصائص الجديدة
- `AttendanceProcessingDetail.php`: محدث مع الحقول والدوال المساعدة
- `Attendance.php`: محدث للتوافق مع النظام الجديد

### 3. الخدمات (Services)
- `AttendanceProcessingService.php`: محدث بالكامل لدعم المعالجة الجديدة
- `SalaryCalculationService.php`: محدث لحساب الرواتب بناءً على النظام الجديد

### 4. مكونات Livewire
- `AttendanceProcessingManager.php`: مكون جديد لإدارة المعالجة
- `attendance-processing-manager.blade.php`: واجهة المستخدم الجديدة

### 5. ملفات إضافية
- `routes/attendance.php`: مسارات نظام الحضور
- `AttendanceProcessingTestSeeder.php`: بيانات تجريبية للاختبار

## كيفية الاستخدام

### 1. تشغيل الهجرات
```bash
php artisan migrate
```

### 2. إنشاء بيانات تجريبية (اختياري)
```bash
php artisan db:seed --class=AttendanceProcessingTestSeeder
```

### 3. إضافة المسارات
أضف المسارات إلى `routes/web.php`:
```php
require __DIR__.'/attendance.php';
```

### 4. الوصول إلى النظام
- رابط معالجة الحضور: `/attendance/processing`
- رابط إدارة الحضور العادي: `/attendance`

## سير العمل

### 1. بدء معالجة جديدة
1. اختر نوع المعالجة (موظف واحد / متعدد / قسم)
2. حدد الموظف/الموظفين/القسم
3. اختر فترة المعالجة (تاريخ البداية والنهاية)
4. أضف ملاحظات (اختياري)
5. اضغط "بدء المعالجة"

### 2. عرض النتائج
- يعرض النظام ملخص المعالجة فور الانتهاء
- يتضمن الملخص: أيام الحضور، أيام الغياب، ساعات العمل، الرواتب
- للأقسام: يعرض ملخص القسم + تفاصيل كل موظف

### 3. إدارة المعالجات
- عرض سجل جميع المعالجات السابقة
- إمكانية عرض التفاصيل اليومية لكل معالجة
- اعتماد أو رفض المعالجات المعلقة

### 4. التفاصيل اليومية
- عرض تفصيلي لكل يوم في فترة المعالجة
- أوقات الدخول والخروج الفعلية
- حساب الساعات والرواتب اليومية
- حالة كل يوم (حضور/غياب/إجازة)

## المزايا الجديدة

### 1. معالجة متقدمة
- دعم أنواع معالجة متعددة
- حساب تلقائي للرواتب
- تتبع مفصل للساعات والأوقات

### 2. واجهة مستخدم محسنة
- تصميم باللغة العربية مع دعم RTL
- عرض واضح للنتائج والإحصائيات
- إدارة سهلة للمعالجات

### 3. مرونة في التكوين
- دعم أنواع رواتب مختلفة
- معاملات قابلة للتخصيص للساعات الإضافية
- إعدادات مناوبات مرنة

### 4. تقارير شاملة
- ملخصات إحصائية للموظفين والأقسام
- تفاصيل يومية لكل معالجة
- حفظ السجلات للمراجعة المستقبلية

## الصيانة والتطوير

### إضافة أنواع رواتب جديدة
لإضافة نوع راتب جديد، قم بتعديل `SalaryCalculationService.php` وأضف method جديد في `calculateSalaryByType()`.

### تخصيص واجهة المستخدم
يمكن تعديل `attendance-processing-manager.blade.php` لتخصيص العرض حسب احتياجاتك.

### إضافة تقارير جديدة
استخدم البيانات المحفوظة في `attendance_processing_details` لإنشاء تقارير مخصصة.

## استكشاف الأخطاء

### مشاكل شائعة
1. **بيانات الموظفين ناقصة**: تأكد من وجود بيانات المناوبات والرواتب
2. **أخطاء في التواريخ**: تحقق من صيغة التواريخ في قاعدة البيانات
3. **مشاكل في الحسابات**: راجع إعدادات معاملات الساعات الإضافية

### سجلات الأخطاء
راجع `storage/logs/laravel.log` لتفاصيل الأخطاء.

## الأمان

- جميع المعالجات محمية بنظام المصادقة
- التحقق من صحة البيانات المدخلة
- حماية من SQL Injection عبر Eloquent ORM

## الخلاصة

النظام المحدث يوفر حلاً شاملاً لمعالجة الحضور وحساب الرواتب مع واجهة مستخدم سهلة الاستخدام ومرونة في التكوين. يمكن توسيعه بسهولة لإضافة ميزات جديدة حسب احتياجات المؤسسة.