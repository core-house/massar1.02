# تقرير أعمار ديون العملاء - دليل المطور

## نظرة عامة
تقرير أعمار ديون العملاء هو تقرير مالي يصنف ديون العملاء حسب الفترات العمرية المختلفة، مما يساعد في إدارة التدفق النقدي ومتابعة حالة الديون.

## بنية التقرير

### الفترات العمرية
يتم تقسيم الديون إلى الفترات التالية:
- **من 1 إلى 15 يوم**: ديون حديثة قابلة للتحصيل بسهولة
- **من 16 إلى 30 يوم**: ديون متوسطة تحتاج متابعة
- **من 31 إلى 60 يوم**: ديون تحتاج اهتمام خاص
- **من 61 إلى 90 يوم**: ديون متأخرة تحتاج إجراءات
- **من 91 إلى 120 يوم**: ديون مشكوك في تحصيلها
- **أكثر من 120 يوم**: ديون معدومة أو صعبة التحصيل

## الكود المستخدم

### 1. الدالة الأساسية
```php
public function getCustomerDebtByAgeRange($customerId, $fromDays, $toDays = null)
{
    $today = Carbon::now()->startOfDay();
    $startDate = $today->copy()->subDays($toDays ?? $fromDays);
    $endDate = $fromDays > 0 ? $today->copy()->subDays($fromDays - 1) : $today;
    
    $debtSum = OperHead::where('acc1', $customerId)
        ->whereBetween('accural_date', [$startDate, $endDate])
        ->selectRaw('SUM(fat_net - paid_from_client) as debt_sum')
        ->value('debt_sum');
        
    return $debtSum ?? 0;
}
```

### 2. شرح المعاملات
- `$customerId`: رقم العميل المراد حساب ديونه
- `$fromDays`: بداية الفترة العمرية (عدد الأيام من اليوم)
- `$toDays`: نهاية الفترة العمرية (اختياري)

### 3. حساب التواريخ

#### تحديد تاريخ اليوم
```php
$today = Carbon::now()->startOfDay();
```
يحصل على تاريخ اليوم من بداية اليوم (00:00:00)

#### تحديد تاريخ البداية
```php
$startDate = $today->copy()->subDays($toDays ?? $fromDays);
```
- ينشئ نسخة من تاريخ اليوم
- يطرح عدد الأيام المحدد
- إذا لم يكن `$toDays` موجود، يستخدم `$fromDays`

#### تحديد تاريخ النهاية
```php
$endDate = $fromDays > 0 ? $today->copy()->subDays($fromDays - 1) : $today;
```
- يطرح `($fromDays - 1)` لتجنب التداخل بين الفترات
- إذا كان `$fromDays` = 0، يستخدم تاريخ اليوم

## أمثلة عملية

### مثال 1: ديون من 1 إلى 15 يوم
```
اليوم: 2024-01-15
$fromDays = 1, $toDays = 15

التواريخ:
- $startDate = 2024-01-15 - 15 يوم = 2024-01-01
- $endDate = 2024-01-15 - (1-1) يوم = 2024-01-14

النطاق: من 2024-01-01 إلى 2024-01-14
```

### مثال 2: ديون من 16 إلى 30 يوم
```
اليوم: 2024-01-15
$fromDays = 16, $toDays = 30

التواريخ:
- $startDate = 2024-01-15 - 30 يوم = 2023-12-16
- $endDate = 2024-01-15 - (16-1) يوم = 2023-12-31

النطاق: من 2023-12-16 إلى 2023-12-31
```

## مخطط توضيحي للفترات

```
اليوم (2024-01-15)
    |
    ├── الفترة 1-15 يوم    : من 2024-01-01 إلى 2024-01-14
    ├── الفترة 16-30 يوم   : من 2023-12-16 إلى 2023-12-31
    ├── الفترة 31-60 يوم   : من 2023-11-16 إلى 2023-12-15
    ├── الفترة 61-90 يوم   : من 2023-10-17 إلى 2023-11-15
    ├── الفترة 91-120 يوم  : من 2023-09-17 إلى 2023-10-16
    └── أكثر من 120 يوم    : قبل 2023-09-17
```

## الدوال المساعدة

### دوال مخصصة لكل فترة
```php
// من 1 إلى 15 يوم
public function getDebt1to15($customerId)
{
    return $this->getCustomerDebtByAgeRange($customerId, 1, 15);
}

// من 16 إلى 30 يوم
public function getDebt16to30($customerId)
{
    return $this->getCustomerDebtByAgeRange($customerId, 16, 30);
}

// الديون أكثر من 120 يوم
public function getDebtOver120($customerId)
{
    $today = Carbon::now()->startOfDay();
    $startDate = $today->copy()->subDays(9999); // تاريخ قديم جداً
    $endDate = $today->copy()->subDays(121);
    
    $debtSum = OperHead::where('acc1', $customerId)
        ->whereBetween('accural_date', [$startDate, $endDate])
        ->selectRaw('SUM(fat_net - paid_from_client) as debt_sum')
        ->value('debt_sum');
        
    return $debtSum ?? 0;
}
```

## حساب المبلغ المستحق

### معادلة حساب الدين
```sql
SUM(fat_net - paid_from_client) as debt_sum
```

حيث:
- `fat_net`: إجمالي قيمة الفاتورة
- `paid_from_client`: المبلغ المدفوع من العميل
- الفرق يمثل المبلغ المستحق

## استخدام التقرير في الواجهة

### عرض البيانات في الجدول
```php
<td>{{ number_format($this->getDebt1to15($customer->id), 2) }}</td>
<td>{{ number_format($this->getDebt16to30($customer->id), 2) }}</td>
<td>{{ number_format($this->getDebt31to60($customer->id), 2) }}</td>
```

### تنسيق الأرقام
- `number_format()`: لتنسيق الأرقام بفاصلتين عشريتين
- يحسن قابلية القراءة للمبالغ المالية

## نصائح للتطوير

### 1. الأداء
- استخدم `selectRaw()` مع `SUM()` لحساب المجموع في قاعدة البيانات
- تجنب جلب جميع السجلات ثم حساب المجموع في PHP

### 2. دقة البيانات
- استخدم `startOfDay()` لضمان دقة المقارنات التاريخية
- تأكد من عدم التداخل بين الفترات العمرية

### 3. التعامل مع القيم الفارغة
- استخدم `?? 0` لضمان إرجاع صفر بدلاً من `null`
- يمنع ظهور أخطاء في الواجهة

## الصيانة والتطوير

### إضافة فترات جديدة
لإضافة فترة عمرية جديدة:
1. أنشئ دالة جديدة باستخدام `getCustomerDebtByAgeRange()`
2. أضف العمود المقابل في الجدول
3. حدث عناوين الأعمدة

### تعديل الفترات الموجودة
- عدل المعاملات في الدوال المختصة
- تأكد من عدم وجود تداخل أو فجوات بين الفترات

## المتطلبات التقنية

### الحزم المطلوبة
- Laravel Framework
- Carbon للتعامل مع التواريخ
- Livewire للمكونات التفاعلية

### قاعدة البيانات
- جدول `oper_head` يحتوي على:
  - `acc1`: رقم العميل
  - `accural_date`: تاريخ الاستحقاق
  - `fat_net`: قيمة الفاتورة
  - `paid_from_client`: المبلغ المدفوع

---

**ملاحظة**: هذا التوثيق يشرح آلية عمل تقرير أعمار ديون العملاء ويمكن الرجوع إليه عند الحاجة لفهم أو تطوير التقرير.
