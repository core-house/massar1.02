<?php

namespace Modules\Authorization\Database\Seeders;

use Illuminate\Database\Seeder;
use Modules\Authorization\Models\Permission;
use Modules\Authorization\Models\Role;

class RoleAndPermissionSeeder extends Seeder
{
    public function run(): void
    {
        $groupedPermissions = [
            'اللوحه الرئيسيه' => ['اللوحه الرئيسيه'],
            'الصفحه الرئيسيه' => ['الصفحه الرئيسيه'],
            'البيانات الاساسيه' => ['العملاء', 'الموردين', 'الصناديق', 'البنوك', 'الموظفين', 'المخازن', 'المصروفات', 'الايرادات', 'دائنين متنوعين', 'مدينين متنوعين', 'الشركاء', 'جارى الشركاء', 'الأصول الثابتة', 'الأصول القابلة للتأجير'],
            'الاصناف' => ['الوحدات', 'المجموعات', 'التصنيفات', 'المواقع', 'الاماكن', 'الطباعة', 'المقاسات', 'الأسعار', 'الأصناف', 'تقرير حركة صنف'],
            'الخصومات' => ['قائمة الخصومات المسموح بها', 'قائمة الخصومات المكتسبة', 'خصم مسموح به', 'خصم مكتسب'],
            'التصنيع' => ['فاتورة تصنيع'],
            'الصلاحيات' => ['الادوار', 'المدراء'],
            'CRM' => ['العملااء', 'مصدر الفرص', 'جهات اتصال الشركات', 'حالات الفرص', 'الفرص'],
            'ادارة المبيعات' => ['فاتورة مبيعات', 'مردود مبيعات', 'أمر بيع', 'عرض سعر لعميل', 'أمر حجز', 'اتفاقية تسعير'],
            'اداره المشتريات' => ['فاتورة مشتريات', 'مردود مشتريات', 'أمر شراء', 'عرض سعر من مورد'],
            'ادارة المخزون' => ['فاتورة تالف', 'أمر صرف', 'أمر إضافة', 'تحويل من مخزن لمخزن'],
            'السندات' => ['سند قبض', 'سند دفع', 'السندات', 'سند دفع متعدد', 'احتساب الثابت للموظفين'],
            'التحويلات النقدية' => ['تحويل نقدية من صندوق لصندوق', 'تحويل نقدية من صندوق لبنك', 'تحويل من بنك لصندوق', 'تحويل من بنك لبنك', 'التحويلات النقدية'],
            'رواتب الموظفين' => ['احتساب الاضافي للموظفين', 'احتساب خصم للموظفين', 'احتساب تأمينات', 'احتساب ضريبة دخل'],
            'الاستحقاقات' => ['سند قبض متعدد', 'اتفاقية خدمة', 'مصروفات مستحقة', 'ايرادات مستحقة', 'احتساب عمولة بنكية', 'عقد بيع', 'توزيع الارباح علي الشركا'],
            'عمليات الاصول' => ['اهلاك الاصل', 'بيع الاصول', 'شراء اصل', 'زيادة في قيمة الاصل', 'نقص في قيمة الاصل'],
            'ادارة الحسابات' => ['قيد يومية', 'قيد يوميه متعدد', 'قيود يومية عمليات', 'قيود يوميه عمليات متعدده', 'قيود يوميه حسابات', 'تسجيل الارصده الافتتاحيه للمخازن', 'تسجيل الرصيد الافتتاحي للحسابات', 'تقرير حركة حساب', 'الميزانيه العموميه'],
            'اداره المشاريع' => ['المشاريع'],
            'الموارد البشريه' => ['الادارات والاقسام', 'الوظائف', 'الدول', 'المحافظات', 'المدن', 'المناطق', 'الورديات', 'الموظفيين', 'المعدلات', 'معدلات اداء الموظفين', 'انواع العقود', 'العقود', 'البصمات', 'معالجه الحضور والانصرف', 'رصيد الإجازات', 'طلبات الإجازة'],
            'الاعدادات' => ['التحكم في الاعدادات'],
            'التقارير' => ['التقارير'],
            'نقاط البيع' => ['نظام نقاط البيع', 'معاملة نقاط البيع', 'تقارير نقاط البيع', 'إعدادات نقاط البيع'],
        ];

        // الحسابات اللي ليها صلاحيات داخلية
        $accountKeys = [
            'العملاء' => 'client',
            'الموردين' => 'supplier',
            'الصناديق' => 'fund',
            'البنوك' => 'bank',
            'الموظفين' => 'employee',
            'المخازن' => 'store',
            'المصروفات' => 'expense',
            'الايرادات' => 'revenue',
            'دائنين متنوعين' => 'creditor',
            'مدينين متنوعين' => 'debtor',
            'الشركاء' => 'partner',
            'جارى الشركاء' => 'current-partner',
            'الأصول الثابتة' => 'asset',
            'الأصول القابلة للتأجير' => 'rentable',
        ];

        $actions = ['عرض', 'إضافة', 'تعديل', 'حذف', 'طباعة'];

        foreach ($groupedPermissions as $category => $permissions) {
            foreach ($permissions as $basePermission) {
                foreach ($actions as $action) {
                    $fullName = "$action $basePermission";

                    // لو دي صلاحية من الحسابات، ضيف internal_name معها
                    $internalName = null;
                    if (isset($accountKeys[$basePermission])) {
                        $key = $accountKeys[$basePermission];
                        $actionKey = match ($action) {
                            'عرض' => 'view',
                            'إضافة' => 'create',
                            'تعديل' => 'edit',
                            'حذف' => 'delete',
                            'طباعة' => 'print',
                            default => ''
                        };
                        $internalName = "$key.$actionKey";
                    }
                    Permission::firstOrCreate(
                        ['name' => $fullName, 'guard_name' => 'web'],
                        ['category' => $category]
                    );
                }
            }
        }

        $adminRole = Role::firstOrCreate(['name' => 'admin'], ['guard_name' => 'web']);
        $userRole = Role::firstOrCreate(['name' => 'user'], ['guard_name' => 'web']);

        $adminRole->syncPermissions(Permission::all());

        $userPermissions = Permission::where('name', 'like', 'عرض%')->pluck('name');
        $userRole->syncPermissions($userPermissions);

        // إنشاء أدوار POS
        $posRoles = [
            'كاشير' => [
                'permissions' => [
                    'عرض نظام نقاط البيع',
                    'إضافة معاملة نقاط البيع',
                    'عرض معاملة نقاط البيع',
                    'طباعة معاملة نقاط البيع',
                ]
            ],
            'مشرف نقاط البيع' => [
                'permissions' => [
                    'عرض نظام نقاط البيع',
                    'إضافة معاملة نقاط البيع',
                    'عرض معاملة نقاط البيع',
                    'تعديل معاملة نقاط البيع',
                    'طباعة معاملة نقاط البيع',
                    'عرض تقارير نقاط البيع',
                ]
            ],
            'مدير نقاط البيع' => [
                'permissions' => [
                    'عرض نظام نقاط البيع',
                    'إضافة معاملة نقاط البيع',
                    'عرض معاملة نقاط البيع',
                    'تعديل معاملة نقاط البيع',
                    'حذف معاملة نقاط البيع',
                    'طباعة معاملة نقاط البيع',
                    'عرض تقارير نقاط البيع',
                    'إضافة إعدادات نقاط البيع',
                    'تعديل إعدادات نقاط البيع',
                ]
            ]
        ];

        foreach ($posRoles as $roleName => $roleData) {
            $role = Role::firstOrCreate([
                'name' => $roleName,
                'guard_name' => 'web'
            ]);

            // إضافة الصلاحيات للدور
            $permissions = Permission::whereIn('name', $roleData['permissions'])->get();
            $role->syncPermissions($permissions);
        }
    }
}
