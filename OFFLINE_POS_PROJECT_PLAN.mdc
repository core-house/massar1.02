# ğŸ“± **Offline POS - Ø®Ø·Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„ÙƒØ§Ù…Ù„Ø©**

## ğŸ¯ **Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©**

Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ¯ÙŠÙˆÙ„ **OfflinePOS** Ù…ØªÙƒØ§Ù…Ù„ ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¸Ø§Ù… Offline-First Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ±.

---

## ğŸ—ï¸ **Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ© (Technical Architecture)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PWA Application                          â”‚
â”‚                     (Progressive Web App)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Alpine.js Frontend Interface                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ POS Screen   â”‚  â”‚   Reports    â”‚  â”‚   Settings   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  IndexedDB (Local Database)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Tables:                                                   â”‚   â”‚
â”‚  â”‚  â€¢ items           (Ø§Ù„Ø£ØµÙ†Ø§Ù + ÙˆØ­Ø¯Ø§Øª + Ø£Ø±ØµØ¯Ø© + Ø£Ø³Ø¹Ø§Ø±)    â”‚   â”‚
â”‚  â”‚  â€¢ customers       (Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡)                             â”‚   â”‚
â”‚  â”‚  â€¢ users           (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ + ØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡)         â”‚   â”‚
â”‚  â”‚  â€¢ transactions    (Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©)                  â”‚   â”‚
â”‚  â”‚  â€¢ sync_queue      (Ù‚Ø§Ø¦Ù…Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©)              â”‚   â”‚
â”‚  â”‚  â€¢ settings        (Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©)                  â”‚   â”‚
â”‚  â”‚  â€¢ stores          (Ø§Ù„Ù…Ø®Ø§Ø²Ù†)                             â”‚   â”‚
â”‚  â”‚  â€¢ employees       (Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†)                            â”‚   â”‚
â”‚  â”‚  â€¢ cash_boxes      (Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚)                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Service Worker (Background Sync)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Sync Manager â”‚  â”‚ Cache Managerâ”‚  â”‚ Offline Queueâ”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Laravel API (Server Side)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Endpoints:                                                â”‚   â”‚
â”‚  â”‚  â€¢ GET  /api/offline-pos/init-data                        â”‚   â”‚
â”‚  â”‚  â€¢ POST /api/offline-pos/sync-transaction                 â”‚   â”‚
â”‚  â”‚  â€¢ POST /api/offline-pos/batch-sync                       â”‚   â”‚
â”‚  â”‚  â€¢ POST /api/offline-pos/return-invoice                   â”‚   â”‚
â”‚  â”‚  â€¢ GET  /api/offline-pos/sync-status/{id}                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MySQL Database (Server)                       â”‚
â”‚  â€¢ oper_heads          â€¢ operation_items                         â”‚
â”‚  â€¢ journal_heads       â€¢ journal_details                         â”‚
â”‚  â€¢ acc_heads           â€¢ items                                   â”‚
â”‚  â€¢ offline_sync_log    (Ø¬Ø¯ÙˆÙ„ ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š **Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (IndexedDB Schema)**

### **1. items (Ø§Ù„Ø£ØµÙ†Ø§Ù)**
```javascript
{
  id: number,              // Ù…Ø¹Ø±Ù Ø§Ù„ØµÙ†Ù
  code: string,            // ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù
  name: string,            // Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù
  description: string,     // Ø§Ù„ÙˆØµÙ
  barcode: string[],       // Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (array)
  category_id: number,     // Ø§Ù„ØªØµÙ†ÙŠÙ
  category_name: string,   // Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ
  is_active: boolean,      // Ù†Ø´Ø·ØŸ
  average_cost: number,    // Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ©
  
  // Ø§Ù„ÙˆØ­Ø¯Ø§Øª
  units: [{
    id: number,
    name: string,
    conversion_factor: number,  // Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„
    is_base: boolean            // ÙˆØ­Ø¯Ø© Ø£Ø³Ø§Ø³ÙŠØ©ØŸ
  }],
  
  // Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
  prices: [{
    price_type_id: number,
    price_type_name: string,
    unit_id: number,
    price: number
  }],
  
  // Ø§Ù„Ø£Ø±ØµØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø®Ø§Ø²Ù† (per branch) âœ…
  stock_balances: [{
    store_id: number,
    store_name: string,
    branch_id: number,      // âœ… Ø¹Ø²Ù„ Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
    quantity: number,
    unit_id: number
  }],
  
  last_synced: timestamp
}
```

### **2. customers (Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡)**
```javascript
{
  id: number,
  code: string,
  name: string,
  phone: string,
  email: string,
  address: string,
  balance: number,         // Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
  credit_limit: number,    // Ø­Ø¯ Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†
  last_synced: timestamp
}
```

### **3. users (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)**
```javascript
{
  id: number,
  name: string,
  email: string,
  permissions: string[],   // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
  settings: object,        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  last_synced: timestamp
}
```

### **4. transactions (Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©)**
```javascript
{
  local_id: string,           // UUID Ù…Ø­Ù„ÙŠ
  server_id: number | null,   // ID Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
  
  // Multi-tenancy & Branch isolation âœ…
  branch_id: number,          // âœ… Ø§Ù„ÙØ±Ø¹ (Ù…Ø¹Ø²ÙˆÙ„ per branch)
  
  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©
  transaction_type: 'sale' | 'return',
  invoice_number: string,
  date: timestamp,
  
  customer_id: number,
  store_id: number,
  employee_id: number,
  cash_box_id: number,
  user_id: number,
  
  // Ø§Ù„Ø£ØµÙ†Ø§Ù
  items: [{
    item_id: number,
    item_name: string,
    unit_id: number,
    unit_name: string,
    quantity: number,
    price: number,
    discount: number,        // Ø®ØµÙ… Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙ†Ù âœ…
    sub_total: number
  }],
  
  // Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
  subtotal: number,
  discount_percentage: number,
  discount_value: number,
  additional_percentage: number,
  additional_value: number,
  total: number,
  
  // Ø§Ù„Ø¯ÙØ¹
  payment_method: 'cash' | 'card' | 'mixed',
  cash_amount: number,
  card_amount: number,
  paid_amount: number,
  change_amount: number,
  
  notes: string,
  
  // Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
  sync_status: 'pending' | 'syncing' | 'synced' | 'error',
  sync_error: string | null,
  sync_attempts: number,
  last_sync_attempt: timestamp | null,
  synced_at: timestamp | null,
  
  created_at: timestamp,
  updated_at: timestamp
}
```

### **5. sync_queue (Ù‚Ø§Ø¦Ù…Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©)**
```javascript
{
  id: string,              // UUID
  transaction_id: string,  // reference to transactions.local_id
  priority: number,        // Ø£ÙˆÙ„ÙˆÙŠØ© (1-10)
  retry_count: number,
  max_retries: number,
  last_error: string | null,
  created_at: timestamp
}
```

### **6. settings (Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)**
```javascript
{
  key: string,
  value: any,
  last_synced: timestamp
}
```

### **7. stores (Ø§Ù„Ù…Ø®Ø§Ø²Ù†)**
```javascript
{
  id: number,
  code: string,
  name: string,
  is_active: boolean,
  last_synced: timestamp
}
```

### **8. employees (Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†)**
```javascript
{
  id: number,
  name: string,
  code: string,
  last_synced: timestamp
}
```

### **9. cash_boxes (Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚)**
```javascript
{
  id: number,
  name: string,
  code: string,
  balance: number,
  last_synced: timestamp
}
```

---

## ğŸ—‚ï¸ **Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„ (Module Structure)**

```
Modules/OfflinePOS/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ Http/
â”‚   â”‚   â”œâ”€â”€ Controllers/
â”‚   â”‚   â”‚   â”œâ”€â”€ OfflinePOSController.php           // Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
â”‚   â”‚   â”‚   â”œâ”€â”€ API/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ InitDataController.php         // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SyncController.php             // Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ItemsController.php            // API Ø§Ù„Ø£ØµÙ†Ø§Ù
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CustomersController.php        // API Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ReportsController.php          // Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ReturnInvoiceController.php    // ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
â”‚   â”‚   â”‚   â””â”€â”€ PrintController.php                // Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©
â”‚   â”‚   â””â”€â”€ Middleware/
â”‚   â”‚       â”œâ”€â”€ CheckOfflinePOSPermission.php      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
â”‚   â”‚       â””â”€â”€ ValidateSyncRequest.php            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
â”‚   â”œâ”€â”€ Services/
â”‚   â”‚   â”œâ”€â”€ InitDataService.php                    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªÙ†Ø²ÙŠÙ„
â”‚   â”‚   â”œâ”€â”€ SyncService.php                        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
â”‚   â”‚   â”œâ”€â”€ TransactionProcessorService.php        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
â”‚   â”‚   â”œâ”€â”€ ConflictResolverService.php            // Ø­Ù„ Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª
â”‚   â”‚   â”œâ”€â”€ ThermalPrinterService.php              // Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©
â”‚   â”‚   â””â”€â”€ ReportService.php                      // Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
â”‚   â”œâ”€â”€ Models/
â”‚   â”‚   â”œâ”€â”€ OfflineSyncLog.php                     // Ø³Ø¬Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
â”‚   â”‚   â””â”€â”€ OfflineTransaction.php                 // Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
â”‚   â””â”€â”€ Providers/
â”‚       â”œâ”€â”€ OfflinePOSServiceProvider.php
â”‚       â””â”€â”€ RouteServiceProvider.php
â”‚
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â”œâ”€â”€ create_offline_sync_logs_table.php
â”‚   â”‚   â””â”€â”€ create_offline_transactions_temp_table.php
â”‚   â””â”€â”€ seeders/
â”‚       â””â”€â”€ OfflinePOSPermissionsSeeder.php
â”‚
â”œâ”€â”€ resources/
â”‚   â”œâ”€â”€ assets/
â”‚   â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â”‚   â”œâ”€â”€ app.js                             // Entry point
â”‚   â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ IndexedDBManager.js            // Ø¥Ø¯Ø§Ø±Ø© IndexedDB
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ schemas.js                     // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ migrations.js                  // Migrations Ù…Ø­Ù„ÙŠØ©
â”‚   â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SyncManager.js                 // Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DataDownloader.js              // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TransactionManager.js          // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CacheManager.js                // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ§Ø´
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PrintManager.js                // Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ NetworkMonitor.js              // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§ØªØµØ§Ù„
â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ pos-screen.js                  // Ø´Ø§Ø´Ø© Ø§Ù„Ø¨ÙŠØ¹ (Alpine Component)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ cart.js                        // Ø§Ù„Ø³Ù„Ø©
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ item-search.js                 // Ø§Ù„Ø¨Ø­Ø«
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ barcode-scanner.js             // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ payment.js                     // Ø§Ù„Ø¯ÙØ¹
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ sync-status.js                 // Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ reports.js                     // Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
â”‚   â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚   â”‚       â”œâ”€â”€ uuid.js                        // ØªÙˆÙ„ÙŠØ¯ UUID
â”‚   â”‚   â”‚       â”œâ”€â”€ formatters.js                  // Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
â”‚   â”‚   â”‚       â””â”€â”€ validators.js                  // Ø§Ù„ØªØ­Ù‚Ù‚
â”‚   â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â”‚   â”œâ”€â”€ offline-pos.css                    // Styles Ø±Ø¦ÙŠØ³ÙŠØ©
â”‚   â”‚   â”‚   â””â”€â”€ thermal-print.css                  // Styles Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©
â”‚   â”‚   â””â”€â”€ icons/                                 // Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª PWA
â”‚   â”‚       â”œâ”€â”€ icon-72x72.png
â”‚   â”‚       â”œâ”€â”€ icon-96x96.png
â”‚   â”‚       â”œâ”€â”€ icon-128x128.png
â”‚   â”‚       â”œâ”€â”€ icon-144x144.png
â”‚   â”‚       â”œâ”€â”€ icon-152x152.png
â”‚   â”‚       â”œâ”€â”€ icon-192x192.png
â”‚   â”‚       â”œâ”€â”€ icon-384x384.png
â”‚   â”‚       â””â”€â”€ icon-512x512.png
â”‚   â”‚
â”‚   â””â”€â”€ views/
â”‚       â”œâ”€â”€ index.blade.php                        // Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
â”‚       â”œâ”€â”€ install.blade.php                      // ØµÙØ­Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª/Ø§Ù„ØªÙ†Ø²ÙŠÙ„
â”‚       â”œâ”€â”€ pos.blade.php                          // Ø´Ø§Ø´Ø© Ø§Ù„Ø¨ÙŠØ¹
â”‚       â”œâ”€â”€ reports/
â”‚       â”‚   â”œâ”€â”€ index.blade.php                    // Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
â”‚       â”‚   â”œâ”€â”€ best-sellers.blade.php             // Ø£ÙƒØ«Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ø¨ÙŠØ¹Ø§Ù‹
â”‚       â”‚   â”œâ”€â”€ top-customers.blade.php            // Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
â”‚       â”‚   â””â”€â”€ daily-sales.blade.php              // Ù…Ø¨ÙŠØ¹Ø§Øª ÙŠÙˆÙ…ÙŠØ©
â”‚       â”œâ”€â”€ print/
â”‚       â”‚   â”œâ”€â”€ thermal-receipt.blade.php          // ÙØ§ØªÙˆØ±Ø© Ø­Ø±Ø§Ø±ÙŠØ©
â”‚       â”‚   â””â”€â”€ a4-invoice.blade.php               // ÙØ§ØªÙˆØ±Ø© A4
â”‚       â””â”€â”€ layouts/
â”‚           â””â”€â”€ master.blade.php
â”‚
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ web.php                                    // Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
â”‚   â””â”€â”€ api.php                                    // Ù…Ø³Ø§Ø±Ø§Øª API
â”‚
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ manifest.json                              // PWA Manifest
â”‚   â”œâ”€â”€ service-worker.js                          // Service Worker
â”‚   â””â”€â”€ offline.html                               // ØµÙØ­Ø© Offline
â”‚
â””â”€â”€ tests/
    â”œâ”€â”€ Feature/
    â”‚   â”œâ”€â”€ SyncTest.php
    â”‚   â””â”€â”€ TransactionTest.php
    â””â”€â”€ Unit/
        â””â”€â”€ ConflictResolverTest.php
```

---

## ğŸ“‹ **Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ÙˆØ§Ù„ØªØ§Ø³ÙƒØ§Øª (Phases & Tasks)**

---

### **ğŸ”· Phase 1: Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„ ÙˆØ§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ©** âœ… **Ù…ÙƒØªÙ…Ù„Ø©**

#### **Task 1.1: Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„** âœ…
- [x] Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ¯ÙŠÙˆÙ„ `OfflinePOS` Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Laravel Modules
- [x] Ø¥Ø¹Ø¯Ø§Ø¯ `module.json`
- [x] Ø¥Ù†Ø´Ø§Ø¡ Service Providers
- [x] ØªØ³Ø¬ÙŠÙ„ Routes
- [x] Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©

**Files:**
- `Modules/OfflinePOS/module.json` âœ…
- `Modules/OfflinePOS/Providers/OfflinePOSServiceProvider.php` âœ…
- `Modules/OfflinePOS/Providers/RouteServiceProvider.php` âœ…

---

#### **Task 1.2: Ø¥Ù†Ø´Ø§Ø¡ Migrations Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©** âœ…

**Migration 1: offline_sync_logs**
```php
Schema::create('offline_sync_logs', function (Blueprint $table) {
    $table->id();
    $table->string('local_transaction_id')->unique(); // UUID Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²
    $table->unsignedBigInteger('server_transaction_id')->nullable(); // ID Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
    $table->unsignedBigInteger('user_id');
    $table->enum('status', ['pending', 'syncing', 'synced', 'error'])->default('pending');
    $table->text('transaction_data')->nullable(); // JSON Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    $table->text('error_message')->nullable();
    $table->integer('sync_attempts')->default(0);
    $table->timestamp('last_sync_attempt')->nullable();
    $table->timestamp('synced_at')->nullable();
    $table->timestamps();
    
    $table->foreign('user_id')->references('id')->on('users')->onDelete('cascade');
    $table->index(['status', 'created_at']);
});
```

**Migration 2: offline_transactions_temp** (Ù…Ø¤Ù‚Øª Ù„Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©)
```php
Schema::create('offline_transactions_temp', function (Blueprint $table) {
    $table->id();
    $table->string('local_id')->unique();
    $table->json('data');
    $table->timestamps();
});
```

**Files:**
- `Modules/OfflinePOS/database/migrations/2026_01_20_170330_create_offline_sync_logs_table.php` âœ…
- `Modules/OfflinePOS/database/migrations/2026_01_20_170332_create_offline_transactions_temp_table.php` âœ…

**Status:** âœ… Migrations created and executed successfully

---

#### **Task 1.3: Ø¥Ù†Ø´Ø§Ø¡ Models** âœ…

**Files:**
- `Modules/OfflinePOS/app/Models/OfflineSyncLog.php` âœ…
- `Modules/OfflinePOS/app/Models/OfflineTransaction.php` âœ…

**Status:** âœ… Models created with relationships and helper methods

---

#### **Task 1.4: Ø¥Ù†Ø´Ø§Ø¡ Permissions Seeder** âœ…

**Permissions Created (18 permissions):**
- `view offline pos system`
- `view offline pos transactions`
- `view offline pos reports`
- `view offline pos sync status`
- `create offline pos transaction`
- `create offline pos return invoice`
- `edit offline pos transaction`
- `edit offline pos settings`
- `delete offline pos transaction`
- `print offline pos invoice`
- `print offline pos thermal`
- `sync offline pos transactions`
- `force sync offline pos`
- `download offline pos data`
- `clear offline pos local data`
- `manage offline pos settings`
- `access offline pos reports advanced`
- `export offline pos reports`

**Files:**
- `Modules/OfflinePOS/database/seeders/OfflinePOSPermissionsSeeder.php` âœ…
- `Modules/OfflinePOS/database/seeders/OfflinePOSDatabaseSeeder.php` âœ…

**Status:** âœ… Seeder executed successfully - 18 permissions created and assigned to default user role

---

#### **Task 1.5: Ø¥Ø¹Ø¯Ø§Ø¯ PWA (Progressive Web App)** âœ…

**manifest.json:**
```json
{
  "name": "Offline POS - Ù†Ø¸Ø§Ù… Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ¹",
  "short_name": "Offline POS",
  "description": "Ù†Ø¸Ø§Ù… Ù†Ù‚Ø§Ø· Ø¨ÙŠØ¹ ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª",
  "start_url": "/offline-pos",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#4F46E5",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "/modules/offlinepos/icons/icon-72x72.png",
      "sizes": "72x72",
      "type": "image/png"
    },
    {
      "src": "/modules/offlinepos/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/modules/offlinepos/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
```

**service-worker.js:** (Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„ÙŠ)
```javascript
const CACHE_NAME = 'offline-pos-v1';
const urlsToCache = [
  '/offline-pos',
  '/offline-pos/pos',
  '/css/offline-pos.css',
  '/js/offline-pos.js'
];

// Install event
self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => cache.addAll(urlsToCache))
  );
});

// Background Sync
self.addEventListener('sync', event => {
  if (event.tag === 'sync-transactions') {
    event.waitUntil(syncTransactions());
  }
});
```

**Files:**
- `Modules/OfflinePOS/public/manifest.json` âœ…
- `Modules/OfflinePOS/public/service-worker.js` âœ…
- `Modules/OfflinePOS/public/offline.html` âœ…
- `Modules/OfflinePOS/resources/assets/icons/README.md` âœ… (Ø¯Ù„ÙŠÙ„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª)

**Status:** âœ… PWA configured with manifest, service worker, and offline page

**Notes:**
- Service Worker ÙŠØ¯Ø¹Ù… Caching Strategies (Network First, Cache First)
- Background Sync Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
- Offline page ØªÙØ§Ø¹Ù„ÙŠØ© Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
- Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ØªØ­ØªØ§Ø¬ Ù„Ù„Ø¥Ù†Ø´Ø§Ø¡ (8 Ø£Ø­Ø¬Ø§Ù… Ù…Ø®ØªÙ„ÙØ©) - Ø§Ù†Ø¸Ø± README

---

#### **Task 1.6: Ø¯Ø¹Ù… Multi-tenancy (stancl/tenancy)** âœ…

**Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…ÙÙ†ÙØ°Ø©:**

1. **Database Migrations:**
   - âœ… Ø¥Ø¶Ø§ÙØ© `branch_id` Ù„Ø¬Ø¯ÙˆÙ„ `offline_sync_logs`
   - âœ… Ø¥Ø¶Ø§ÙØ© `branch_id` Ù„Ø¬Ø¯ÙˆÙ„ `offline_transactions_temp`
   - âœ… Ø¥Ø¶Ø§ÙØ© Indexes Ù„Ù„ÙÙ„ØªØ±Ø© per branch

2. **Models:**
   - âœ… Ø¥Ø¶Ø§ÙØ© `branch_id` ÙÙŠ fillable
   - âœ… Ø¥Ø¶Ø§ÙØ© scope `forBranch()` Ù„Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹
   - âœ… Ø¯Ø¹Ù… tenant isolation (ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† stancl/tenancy)

3. **Middleware:**
   - âœ… `EnsureBranchContext` - Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³ÙŠØ§Ù‚ Ø§Ù„ÙØ±Ø¹
   - âœ… `CheckOfflinePOSPermission` - Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª per-tenant
   
4. **Routes:**
   - âœ… Web routes Ù…Ø­Ù…ÙŠØ© Ø¨Ù€ `InitializeTenancyByDomain`
   - âœ… API routes Ù…Ø­Ù…ÙŠØ© Ø¨Ù€ Sanctum + Tenancy middleware
   - âœ… Ø¯Ø¹Ù… subdomain routing (tenant1.domain.com)

**Architecture:**
```
tenant1.domain.com â†’ Database 1
  â”œâ”€â”€ Branch 1 (branch_id: 1)
  â”œâ”€â”€ Branch 2 (branch_id: 2)
  â””â”€â”€ Offline data isolated per branch âœ…

tenant2.domain.com â†’ Database 2
  â”œâ”€â”€ Branch 1 (branch_id: 1)
  â””â”€â”€ Offline data isolated per branch âœ…
```

**Files:**
- `app/Http/Middleware/EnsureBranchContext.php` âœ…
- `app/Http/Middleware/CheckOfflinePOSPermission.php` âœ…
- `routes/web.php` âœ… (updated with tenancy middleware)
- `routes/api.php` âœ… (updated with tenancy middleware)
- `database/migrations/*` âœ… (updated with branch_id)
- `app/Models/*` âœ… (updated with branch scope)

**Status:** âœ… Multi-tenancy support added successfully

**Integration Verified:**
- âœ… `InitializeTenancyBySubdomain` middleware (matching project setup)
- âœ… Per-tenant database isolation
- âœ… Per-branch data isolation
- âœ… Automatic migrations on tenant creation
- âœ… Automatic permissions seeding
- âœ… See: `TENANCY_INTEGRATION_CHECKLIST.md` for verification steps

---

### **ğŸ”· Phase 2: API Endpoints Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª** ğŸ”„ **Ø§Ù„ØªØ§Ù„ÙŠØ©**

#### **Task 2.1: API ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© (Init Data)**

**Endpoint:** `GET /api/offline-pos/init-data`

**Response:**
```json
{
  "success": true,
  "data": {
    "items": [...],           // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ø¹ ØªÙØ§ØµÙŠÙ„Ù‡Ø§
    "customers": [...],       // Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    "stores": [...],          // Ø§Ù„Ù…Ø®Ø§Ø²Ù†
    "employees": [...],       // Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
    "cash_boxes": [...],      // Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚
    "user": {                 // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
      "id": 1,
      "name": "...",
      "permissions": [...]
    },
    "settings": {...},        // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    "categories": [...],      // Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
    "price_types": [...]      // Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
  },
  "metadata": {
    "total_items": 1500,
    "total_customers": 300,
    "last_updated": "2026-01-20 12:00:00",
    "version": "1.0.0"
  }
}
```

**Files:**
- `Modules/OfflinePOS/app/Http/Controllers/API/InitDataController.php`
- `Modules/OfflinePOS/app/Services/InitDataService.php`

---

#### **Task 2.2: API Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Sync)**

**Endpoint:** `POST /api/offline-pos/sync-transaction`

**Request:**
```json
{
  "local_id": "uuid-xxxx-xxxx-xxxx",
  "transaction": {
    "type": "sale",
    "date": "2026-01-20 14:30:00",
    "customer_id": 61,
    "store_id": 62,
    "employee_id": 65,
    "cash_box_id": 59,
    "items": [
      {
        "item_id": 100,
        "unit_id": 1,
        "quantity": 2,
        "price": 50,
        "discount": 5,
        "row_total": 95
      }
    ],
    "subtotal": 95,
    "discount_value": 10,
    "total": 85,
    "payment_method": "cash",
    "paid_amount": 100,
    "change_amount": 15
  }
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "server_transaction_id": 1234,
    "invoice_number": "INV-2026-001234",
    "created_at": "2026-01-20 14:30:15"
  },
  "message": "ØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­"
}
```

**Files:**
- `Modules/OfflinePOS/app/Http/Controllers/API/SyncController.php`
- `Modules/OfflinePOS/app/Services/SyncService.php`
- `Modules/OfflinePOS/app/Services/TransactionProcessorService.php`

---

#### **Task 2.3: API Batch Sync (Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©)**

**Endpoint:** `POST /api/offline-pos/batch-sync`

**Request:**
```json
{
  "transactions": [
    {
      "local_id": "uuid-1",
      "transaction": {...}
    },
    {
      "local_id": "uuid-2",
      "transaction": {...}
    }
  ]
}
```

**Response:**
```json
{
  "success": true,
  "results": [
    {
      "local_id": "uuid-1",
      "status": "synced",
      "server_id": 1234
    },
    {
      "local_id": "uuid-2",
      "status": "error",
      "error": "Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ"
    }
  ],
  "summary": {
    "total": 2,
    "synced": 1,
    "failed": 1
  }
}
```

**Files:**
- Ù†ÙØ³ SyncController Ù…Ø¹ method Ø¬Ø¯ÙŠØ¯

---

#### **Task 2.4: API ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª**

**Endpoint:** `POST /api/offline-pos/return-invoice`

**Request:**
```json
{
  "original_invoice_id": 1234,
  "return_items": [
    {
      "item_id": 100,
      "quantity": 1,
      "price": 50,
      "reason": "ØªØ§Ù„Ù"
    }
  ],
  "notes": "..."
}
```

**Files:**
- `Modules/OfflinePOS/app/Http/Controllers/API/ReturnInvoiceController.php`

---

#### **Task 2.5: API Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±**

**Endpoints:**
- `GET /api/offline-pos/reports/best-sellers?from=...&to=...`
- `GET /api/offline-pos/reports/top-customers?from=...&to=...`
- `GET /api/offline-pos/reports/daily-sales?date=...`
- `GET /api/offline-pos/reports/sales-summary?from=...&to=...`

**Files:**
- `Modules/OfflinePOS/app/Http/Controllers/API/ReportsController.php`
- `Modules/OfflinePOS/app/Services/ReportService.php`

---

### **ğŸ”· Phase 3: IndexedDB & Local Storage**

#### **Task 3.1: Ø¥Ù†Ø´Ø§Ø¡ IndexedDB Manager**

**File:** `Modules/OfflinePOS/resources/assets/js/db/IndexedDBManager.js`

```javascript
class IndexedDBManager {
  constructor(dbName = 'OfflinePOSDB', version = 1) {
    this.dbName = dbName;
    this.version = version;
    this.db = null;
  }

  async init() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.dbName, this.version);
      
      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        this.db = request.result;
        resolve(this.db);
      };
      
      request.onupgradeneeded = (event) => {
        this.db = event.target.result;
        this.createStores();
      };
    });
  }

  createStores() {
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    if (!this.db.objectStoreNames.contains('items')) {
      const itemsStore = this.db.createObjectStore('items', { keyPath: 'id' });
      itemsStore.createIndex('code', 'code', { unique: false });
      itemsStore.createIndex('name', 'name', { unique: false });
      itemsStore.createIndex('barcode', 'barcode', { unique: false, multiEntry: true });
    }
    
    if (!this.db.objectStoreNames.contains('customers')) {
      const customersStore = this.db.createObjectStore('customers', { keyPath: 'id' });
      customersStore.createIndex('name', 'name', { unique: false });
    }
    
    if (!this.db.objectStoreNames.contains('transactions')) {
      const transactionsStore = this.db.createObjectStore('transactions', { keyPath: 'local_id' });
      transactionsStore.createIndex('sync_status', 'sync_status', { unique: false });
      transactionsStore.createIndex('created_at', 'created_at', { unique: false });
    }
    
    // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    // item units.
    // item barcodes.
    // items warehouses (stores) balnce.
    // items prices.
    // cash boxs

  }

  async add(storeName, data) {
    const tx = this.db.transaction(storeName, 'readwrite');
    const store = tx.objectStore(storeName);
    return store.add(data);
  }

  async put(storeName, data) {
    const tx = this.db.transaction(storeName, 'readwrite');
    const store = tx.objectStore(storeName);
    return store.put(data);
  }

  async get(storeName, key) {
    const tx = this.db.transaction(storeName, 'readonly');
    const store = tx.objectStore(storeName);
    return store.get(key);
  }

  async getAll(storeName) {
    const tx = this.db.transaction(storeName, 'readonly');
    const store = tx.objectStore(storeName);
    return store.getAll();
  }

  async delete(storeName, key) {
    const tx = this.db.transaction(storeName, 'readwrite');
    const store = tx.objectStore(storeName);
    return store.delete(key);
  }

  async clear(storeName) {
    const tx = this.db.transaction(storeName, 'readwrite');
    const store = tx.objectStore(storeName);
    return store.clear();
  }

  async getAllByIndex(storeName, indexName, value) {
    const tx = this.db.transaction(storeName, 'readonly');
    const store = tx.objectStore(storeName);
    const index = store.index(indexName);
    return index.getAll(value);
  }
}

export default IndexedDBManager;
```

---

#### **Task 3.2: Data Downloader (ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)**

**File:** `Modules/OfflinePOS/resources/assets/js/services/DataDownloader.js`

```javascript
class DataDownloader {
  constructor(dbManager) {
    this.db = dbManager;
    this.apiUrl = '/api/offline-pos/init-data';
  }

  async downloadInitialData(onProgress) {
    try {
      // Ø¹Ø±Ø¶ progress
      onProgress({ step: 'fetching', percent: 0, message: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...' });
      
      const response = await fetch(this.apiUrl);
      const { data, metadata } = await response.json();
      
      // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£ØµÙ†Ø§Ù
      onProgress({ step: 'items', percent: 20, message: 'ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£ØµÙ†Ø§Ù...' });
      await this.saveItems(data.items);
      
      // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
      onProgress({ step: 'customers', percent: 40, message: 'ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...' });
      await this.saveCustomers(data.customers);
      
      // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø®Ø§Ø²Ù†
      onProgress({ step: 'items_stores', percent: 60, message: 'ØªØ®Ø²ÙŠÙ† Ø§Ø±ØµØ¯Ù‡ Ø§Ù„Ù…Ø®Ø§Ø²Ù†...' });
      await this.saveStores(data.stores);
      
      // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
      onProgress({ step: 'done', percent: 100, message: 'Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªÙ†Ø²ÙŠÙ„!' });
      
      return { success: true, metadata };
    } catch (error) {
      console.error('Error downloading data:', error);
      throw error;
    }
  }

  async saveItems(items) {
    await this.db.clear('items');
    for (const item of items) {
      await this.db.add('items', item);
    }
  }

  async saveCustomers(customers) {
    await this.db.clear('customers');
    for (const customer of customers) {
      await this.db.add('customers', customer);
    }
  }

  // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„
}

export default DataDownloader;
```

---

#### **Task 3.3: Transaction Manager (Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª)**

**File:** `Modules/OfflinePOS/resources/assets/js/services/TransactionManager.js`

```javascript
import { v4 as uuidv4 } from 'uuid';

class TransactionManager {
  constructor(dbManager) {
    this.db = dbManager;
  }

  async createTransaction(transactionData) {
    const transaction = {
      local_id: uuidv4(),
      server_id: null,
      ...transactionData,
      sync_status: 'pending',
      sync_error: null,
      sync_attempts: 0,
      last_sync_attempt: null,
      synced_at: null,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };

    await this.db.add('transactions', transaction);
    await this.addToSyncQueue(transaction.local_id);
    
    return transaction;
  }

  async addToSyncQueue(transactionId) {
    const queueItem = {
      id: uuidv4(),
      transaction_id: transactionId,
      priority: 5,
      retry_count: 0,
      max_retries: 5,
      last_error: null,
      created_at: new Date().toISOString()
    };

    await this.db.add('sync_queue', queueItem);
  }

  async getPendingTransactions() {
    return await this.db.getAllByIndex('transactions', 'sync_status', 'pending');
  }

  async updateTransactionStatus(localId, status, serverId = null, error = null) {
    const transaction = await this.db.get('transactions', localId);
    
    transaction.sync_status = status;
    transaction.updated_at = new Date().toISOString();
    
    if (serverId) transaction.server_id = serverId;
    if (error) transaction.sync_error = error;
    if (status === 'synced') transaction.synced_at = new Date().toISOString();
    
    await this.db.put('transactions', transaction);
  }
}

export default TransactionManager;
```

---

#### **Task 3.4: Sync Manager (Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©)**

**File:** `Modules/OfflinePOS/resources/assets/js/services/SyncManager.js`

```javascript
class SyncManager {
  constructor(dbManager, transactionManager) {
    this.db = dbManager;
    this.transactionManager = transactionManager;
    this.isSyncing = false;
    this.syncInterval = null;
  }

  async startAutoSync(intervalMinutes = 5) {
    this.syncInterval = setInterval(() => {
      this.syncPendingTransactions();
    }, intervalMinutes * 60 * 1000);
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ©
    await this.syncPendingTransactions();
  }

  stopAutoSync() {
    if (this.syncInterval) {
      clearInterval(this.syncInterval);
      this.syncInterval = null;
    }
  }

  async syncPendingTransactions() {
    if (this.isSyncing) return;
    if (!navigator.onLine) return;

    this.isSyncing = true;

    try {
      const pending = await this.transactionManager.getPendingTransactions();
      
      for (const transaction of pending) {
        await this.syncSingleTransaction(transaction);
      }
    } catch (error) {
      console.error('Sync error:', error);
    } finally {
      this.isSyncing = false;
    }
  }

  async syncSingleTransaction(transaction) {
    try {
      await this.transactionManager.updateTransactionStatus(
        transaction.local_id,
        'syncing'
      );

      const response = await fetch('/api/offline-pos/sync-transaction', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
          local_id: transaction.local_id,
          transaction: transaction
        })
      });

      const result = await response.json();

      if (result.success) {
        await this.transactionManager.updateTransactionStatus(
          transaction.local_id,
          'synced',
          result.data.server_transaction_id
        );
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      await this.transactionManager.updateTransactionStatus(
        transaction.local_id,
        'error',
        null,
        error.message
      );
      
      transaction.sync_attempts++;
      await this.db.put('transactions', transaction);
    }
  }

  async forceSyncAll() {
    this.isSyncing = false;
    await this.syncPendingTransactions();
  }
}

export default SyncManager;
```

---

### **ğŸ”· Phase 4: Frontend - Alpine.js**

#### **Task 4.1: Ø´Ø§Ø´Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©**

**File:** `Modules/OfflinePOS/resources/assets/js/components/pos-screen.js`

```javascript
export default function posScreen() {
  return {
    // State
    cart: [],
    searchTerm: '',
    searchResults: [],
    barcode: '',
    selectedCategory: null,
    
    // Transaction
    customer_id: 61,
    store_id: 62,
    employee_id: 65,
    cash_box_id: 59,
    
    // Totals
    subtotal: 0,
    discount_percentage: 0,
    discount_value: 0,
    total: 0,
    
    // Payment
    payment_method: 'cash',
    cash_amount: 0,
    card_amount: 0,
    change_amount: 0,
    
    // DB
    db: null,
    transactionManager: null,
    
    // Init
    async init() {
      this.db = new IndexedDBManager();
      await this.db.init();
      
      this.transactionManager = new TransactionManager(this.db);
      
      // Listen to barcode scanner
      this.listenToBarcode();
    },
    
    // Search
    async searchItems() {
      if (this.searchTerm.length < 2) {
        this.searchResults = [];
        return;
      }
      
      const allItems = await this.db.getAll('items');
      this.searchResults = allItems.filter(item => 
        item.name.includes(this.searchTerm) || 
        item.code.includes(this.searchTerm)
      ).slice(0, 10);
    },
    
    // Add to cart
    addItemToCart(item) {
      const existingIndex = this.cart.findIndex(i => i.item_id === item.id);
      
      if (existingIndex !== -1) {
        this.cart[existingIndex].quantity++;
      } else {
        this.cart.push({
          item_id: item.id,
          item_name: item.name,
          unit_id: item.units[0].id,
          unit_name: item.units[0].name,
          quantity: 1,
          price: item.prices[0].price,
          discount: 0,  // Ø®ØµÙ… Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙ†Ù âœ…
          sub_total: item.prices[0].price
        });
      }
      
      this.calculateTotals();
      this.searchTerm = '';
      this.searchResults = [];
    },
    
    // Barcode
    listenToBarcode() {
      document.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter' && this.barcode) {
          await this.addItemByBarcode();
          this.barcode = '';
        }
      });
    },
    
    async addItemByBarcode() {
      const items = await this.db.getAllByIndex('items', 'barcode', this.barcode);
      if (items.length > 0) {
        this.addItemToCart(items[0]);
      }
    },
    
    // Calculate
    calculateTotals() {
      this.subtotal = this.cart.reduce((sum, item) => {
        item.sub_total = (item.quantity * item.price) - item.discount;
        return sum + item.sub_total;
      }, 0);
      
      this.discount_value = (this.subtotal * this.discount_percentage) / 100;
      this.total = this.subtotal - this.discount_value;
      
      if (this.payment_method === 'cash') {
        this.cash_amount = this.total;
        this.card_amount = 0;
      } else if (this.payment_method === 'card') {
        this.card_amount = this.total;
        this.cash_amount = 0;
      }
      
      this.calculateChange();
    },
    
    calculateChange() {
      const paid = this.cash_amount + this.card_amount;
      this.change_amount = Math.max(0, paid - this.total);
    },
    
    // Save
    async saveTransaction() {
      const transaction = {
        transaction_type: 'sale',
        invoice_number: 'TEMP-' + Date.now(),
        date: new Date().toISOString(),
        customer_id: this.customer_id,
        store_id: this.store_id,
        employee_id: this.employee_id,
        cash_box_id: this.cash_box_id,
        user_id: window.currentUserId,
        items: this.cart,
        subtotal: this.subtotal,
        discount_percentage: this.discount_percentage,
        discount_value: this.discount_value,
        total: this.total,
        payment_method: this.payment_method,
        cash_amount: this.cash_amount,
        card_amount: this.card_amount,
        paid_amount: this.cash_amount + this.card_amount,
        change_amount: this.change_amount
      };
      
      const saved = await this.transactionManager.createTransaction(transaction);
      
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹! Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.');
      
      this.resetForm();
    },
    
    resetForm() {
      this.cart = [];
      this.subtotal = 0;
      this.discount_percentage = 0;
      this.discount_value = 0;
      this.total = 0;
      this.cash_amount = 0;
      this.card_amount = 0;
      this.change_amount = 0;
    }
  }
}
```

---

#### **Task 4.2: Blade View Ù„Ù„Ù€ POS**

**File:** `Modules/OfflinePOS/resources/views/pos.blade.php`

```blade
@extends('offlinepos::layouts.master')

@section('content')
<div x-data="posScreen()" x-init="init()" class="pos-container">
  {{-- Header --}}
  <div class="pos-header">
    <h1>Ù†Ø¸Ø§Ù… Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ¹ - Offline</h1>
    <div x-data="syncStatus()">
      <span x-show="isOnline" class="badge bg-success">Ù…ØªØµÙ„</span>
      <span x-show="!isOnline" class="badge bg-danger">ØºÙŠØ± Ù…ØªØµÙ„</span>
      <span x-show="pendingCount > 0" class="badge bg-warning">
        <span x-text="pendingCount"></span> Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
      </span>
    </div>
  </div>
  
  {{-- Main Content --}}
  <div class="pos-content">
    {{-- Left: Items & Search --}}
    <div class="pos-left">
      <input 
        type="text" 
        x-model="searchTerm" 
        @input.debounce.300ms="searchItems()"
        placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù..."
        class="form-control mb-3"
      >
      
      <div class="search-results">
        <template x-for="item in searchResults" :key="item.id">
          <div @click="addItemToCart(item)" class="item-card">
            <span x-text="item.name"></span>
            <span x-text="item.prices[0].price + ' Ø±ÙŠØ§Ù„'"></span>
          </div>
        </template>
      </div>
    </div>
    
    {{-- Right: Cart & Payment --}}
    <div class="pos-right">
      <div class="cart">
        <table class="table">
          <thead>
            <tr>
              <th>Ø§Ù„ØµÙ†Ù</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th>Ø§Ù„Ø³Ø¹Ø±</th>
              <th>Ø®ØµÙ…</th>
              <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(item, index) in cart" :key="index">
              <tr>
                <td x-text="item.item_name"></td>
                <td>
                  <input 
                    type="number" 
                    x-model.number="item.quantity" 
                    @input="calculateTotals()"
                    class="form-control form-control-sm"
                  >
                </td>
                <td x-text="item.price"></td>
                <td>
                  <input 
                    type="number" 
                    x-model.number="item.discount" 
                    @input="calculateTotals()"
                    class="form-control form-control-sm"
                    placeholder="Ø®ØµÙ… Ø§Ù„ØµÙ†Ù"
                  >
                </td>
                <td x-text="item.sub_total"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
      
      <div class="totals">
        <div class="total-row">
          <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
          <span x-text="subtotal"></span>
        </div>
        <div class="total-row">
          <span>Ø§Ù„Ø®ØµÙ…:</span>
          <input type="number" x-model.number="discount_percentage" @input="calculateTotals()">
          <span x-text="discount_value"></span>
        </div>
        <div class="total-row total-final">
          <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
          <span x-text="total"></span>
        </div>
      </div>
      
      <div class="payment">
        <select x-model="payment_method" @change="calculateTotals()">
          <option value="cash">Ù†Ù‚Ø¯ÙŠ</option>
          <option value="card">Ø¨Ø·Ø§Ù‚Ø©</option>
          <option value="mixed">Ù…Ø®ØªÙ„Ø·</option>
        </select>
        
        <div x-show="payment_method === 'cash' || payment_method === 'mixed'">
          <input type="number" x-model.number="cash_amount" @input="calculateChange()" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‚Ø¯ÙŠ">
        </div>
        
        <div x-show="payment_method === 'card' || payment_method === 'mixed'">
          <input type="number" x-model.number="card_amount" @input="calculateChange()" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©">
        </div>
        
        <div class="change">
          <span>Ø§Ù„Ø¨Ø§Ù‚ÙŠ: </span>
          <span x-text="change_amount"></span>
        </div>
      </div>
      
      <button @click="saveTransaction()" class="btn btn-primary btn-lg w-100">
        Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
      </button>
    </div>
  </div>
</div>
@endsection

@push('scripts')
<script src="{{ asset('modules/offlinepos/js/app.js') }}" type="module"></script>
@endpush
```

---

#### **Task 4.3: Sync Status Component**

**File:** `Modules/OfflinePOS/resources/assets/js/components/sync-status.js`

```javascript
export default function syncStatus() {
  return {
    isOnline: navigator.onLine,
    pendingCount: 0,
    syncManager: null,
    
    async init() {
      // Monitor online/offline
      window.addEventListener('online', () => {
        this.isOnline = true;
        this.syncManager.syncPendingTransactions();
      });
      
      window.addEventListener('offline', () => {
        this.isOnline = false;
      });
      
      // Update pending count
      setInterval(async () => {
        await this.updatePendingCount();
      }, 5000);
      
      await this.updatePendingCount();
    },
    
    async updatePendingCount() {
      const db = new IndexedDBManager();
      await db.init();
      const pending = await db.getAllByIndex('transactions', 'sync_status', 'pending');
      this.pendingCount = pending.length;
    }
  }
}
```

---

### **ğŸ”· Phase 5: Service Worker & Background Sync**

#### **Task 5.1: ØªØ·ÙˆÙŠØ± Service Worker Ø§Ù„ÙƒØ§Ù…Ù„**

**File:** `Modules/OfflinePOS/public/service-worker.js`

```javascript
const CACHE_NAME = 'offline-pos-v1';
const OFFLINE_URL = '/offline-pos/offline';

// Install
self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME).then(cache => {
      return cache.addAll([
        '/offline-pos',
        '/offline-pos/pos',
        '/css/offline-pos.css',
        '/js/offline-pos.js',
        OFFLINE_URL
      ]);
    })
  );
  self.skipWaiting();
});

// Activate
self.addEventListener('activate', event => {
  event.waitUntil(
    caches.keys().then(cacheNames => {
      return Promise.all(
        cacheNames.map(cacheName => {
          if (cacheName !== CACHE_NAME) {
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
  self.clients.claim();
});

// Fetch
self.addEventListener('fetch', event => {
  if (event.request.mode === 'navigate') {
    event.respondWith(
      fetch(event.request).catch(() => {
        return caches.match(OFFLINE_URL);
      })
    );
  } else {
    event.respondWith(
      caches.match(event.request).then(response => {
        return response || fetch(event.request);
      })
    );
  }
});

// Background Sync
self.addEventListener('sync', event => {
  if (event.tag === 'sync-transactions') {
    event.waitUntil(syncTransactions());
  }
});

async function syncTransactions() {
  const db = await openDB();
  const tx = db.transaction('transactions', 'readonly');
  const store = tx.objectStore('transactions');
  const index = store.index('sync_status');
  const pending = await index.getAll('pending');
  
  for (const transaction of pending) {
    try {
      await fetch('/api/offline-pos/sync-transaction', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          local_id: transaction.local_id,
          transaction: transaction
        })
      });
    } catch (error) {
      console.error('Background sync failed:', error);
    }
  }
}

function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('OfflinePOSDB');
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}
```

---

### **ğŸ”· Phase 6: Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©**

#### **Task 6.1: Ø®ØµÙˆÙ…Ø§Øª Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙ†Ù**
âœ… **ØªÙ… ØªÙ†ÙÙŠØ°Ù‡** ÙÙŠ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© - ÙƒÙ„ ØµÙ†Ù ÙÙŠ Ø§Ù„Ø³Ù„Ø© Ù„Ù‡ Ø­Ù‚Ù„ `discount` Ù…Ù†ÙØµÙ„

---

#### **Task 6.2: ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª**

**API Endpoint:**
```php
// ReturnInvoiceController.php
public function create(Request $request)
{
    $validated = $request->validate([
        'original_invoice_id' => 'required|exists:oper_heads,id',
        'return_items' => 'required|array',
        'return_items.*.item_id' => 'required|exists:items,id',
        'return_items.*.quantity' => 'required|numeric|min:0',
        'return_items.*.reason' => 'nullable|string',
        'notes' => 'nullable|string'
    ]);
    
    // Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ù…Ø±ØªØ¬Ø¹Ø© (pro_type = 12)
    // ...
}
```

**Frontend Component:**
```javascript
// return-invoice.js
export default function returnInvoice() {
  return {
    originalInvoiceId: null,
    returnItems: [],
    
    async loadOriginalInvoice(invoiceId) {
      // Ø¬Ù„Ø¨ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
      // Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±
    },
    
    async processReturn() {
      // Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ù…Ø­Ù„ÙŠØ§Ù‹
      // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù€ sync queue
    }
  }
}
```

---

#### **Task 6.3: ØªÙ‚Ø§Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠØ©**

**1. Ø£ÙƒØ«Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ø¨ÙŠØ¹Ø§Ù‹:**
```javascript
async getBestSellers(fromDate, toDate) {
  const transactions = await this.db.getAll('transactions');
  const filtered = transactions.filter(t => 
    t.date >= fromDate && t.date <= toDate && t.sync_status === 'synced'
  );
  
  const itemSales = {};
  filtered.forEach(transaction => {
    transaction.items.forEach(item => {
      if (!itemSales[item.item_id]) {
        itemSales[item.item_id] = {
          item_name: item.item_name,
          total_quantity: 0,
          total_value: 0
        };
      }
      itemSales[item.item_id].total_quantity += item.quantity;
      itemSales[item.item_id].total_value += item.sub_total;
    });
  });
  
  return Object.values(itemSales).sort((a, b) => b.total_value - a.total_value);
}
```

**2. Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:**
```javascript
async getTopCustomers(fromDate, toDate) {
  const transactions = await this.db.getAll('transactions');
  const filtered = transactions.filter(t => 
    t.date >= fromDate && t.date <= toDate && t.sync_status === 'synced'
  );
  
  const customerSales = {};
  filtered.forEach(transaction => {
    if (!customerSales[transaction.customer_id]) {
      customerSales[transaction.customer_id] = {
        total_purchases: 0,
        transaction_count: 0
      };
    }
    customerSales[transaction.customer_id].total_purchases += transaction.total;
    customerSales[transaction.customer_id].transaction_count++;
  });
  
  return Object.entries(customerSales)
    .sort((a, b) => b[1].total_purchases - a[1].total_purchases)
    .slice(0, 10);
}
```

---

#### **Task 6.4: Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©**

**File:** `Modules/OfflinePOS/app/Services/ThermalPrinterService.php`

```php
class ThermalPrinterService
{
    public function generateESCPOSCommands($transaction)
    {
        $esc = "\x1B";
        $gs = "\x1D";
        
        $output = '';
        
        // Initialize
        $output .= $esc . "@";
        
        // Center align
        $output .= $esc . "a" . chr(1);
        
        // Company name (bold, double size)
        $output .= $esc . "!" . chr(0x30);
        $output .= "Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©\n";
        $output .= $esc . "!" . chr(0);
        
        // Invoice details
        $output .= "ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª\n";
        $output .= "Ø±Ù‚Ù…: " . $transaction->invoice_number . "\n";
        $output .= "Ø§Ù„ØªØ§Ø±ÙŠØ®: " . $transaction->date . "\n";
        $output .= str_repeat("-", 32) . "\n";
        
        // Left align
        $output .= $esc . "a" . chr(0);
        
        // Items
        foreach ($transaction->items as $item) {
            $output .= $item->item_name . "\n";
            $output .= sprintf(
                "%d x %.2f = %.2f\n",
                $item->quantity,
                $item->price,
                $item->discount,
                $item->sub_total
            );
        }
        
        $output .= str_repeat("-", 32) . "\n";
        
        // Totals
        $output .= sprintf("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: %.2f\n", $transaction->subtotal);
        $output .= sprintf("Ø§Ù„Ø®ØµÙ…: %.2f\n", $transaction->discount_value);
        $output .= $esc . "!" . chr(0x10);
        $output .= sprintf("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: %.2f\n", $transaction->total);
        $output .= $esc . "!" . chr(0);
        
        // Cut paper
        $output .= $gs . "V" . chr(66) . chr(0);
        
        return $output;
    }
    
    public function printToUSB($commands)
    {
        // Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø¨Ø± USB
        // ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø© Ù…Ø«Ù„ mike42/escpos-php
    }
}
```

**Frontend Print Manager:**
```javascript
// PrintManager.js
class PrintManager {
  async printThermal(transaction) {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Web USB API Ø£Ùˆ Web Serial API
    try {
      const port = await navigator.serial.requestPort();
      await port.open({ baudRate: 9600 });
      
      const writer = port.writable.getWriter();
      const encoder = new TextEncoder();
      
      // Ø¥Ø±Ø³Ø§Ù„ Ø£ÙˆØ§Ù…Ø± ESC/POS
      await writer.write(encoder.encode(this.generateCommands(transaction)));
      
      writer.releaseLock();
      await port.close();
    } catch (error) {
      console.error('Print error:', error);
    }
  }
  
  generateCommands(transaction) {
    // ØªÙˆÙ„ÙŠØ¯ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    // ...
  }
}
```

---

## ğŸ“ **Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨**

### **Step-by-Step Implementation:**

1. âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ `OfflinePOS`
2. âœ… Ø¥Ø¹Ø¯Ø§Ø¯ Migrations & Models
3. âœ… Ø¥Ù†Ø´Ø§Ø¡ Permissions Seeder
4. âœ… Ø¥Ø¹Ø¯Ø§Ø¯ PWA (Manifest + Service Worker)
5. âœ… Ø¨Ù†Ø§Ø¡ API Endpoints (InitData, Sync, Reports, Return)
6. âœ… Ø¥Ù†Ø´Ø§Ø¡ IndexedDB Manager
7. âœ… Ø¨Ù†Ø§Ø¡ Data Downloader
8. âœ… Ø¨Ù†Ø§Ø¡ Transaction Manager
9. âœ… Ø¨Ù†Ø§Ø¡ Sync Manager
10. âœ… ØªØ·ÙˆÙŠØ± Frontend Ø¨Ù€ Alpine.js
11. âœ… Ø¥Ø¶Ø§ÙØ© Barcode Scanner
12. âœ… Ø¥Ø¶Ø§ÙØ© Ø®ØµÙˆÙ…Ø§Øª Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙ†Ù
13. âœ… ØªØ·ÙˆÙŠØ± Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
14. âœ… Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
15. âœ… ØªØ·ÙˆÙŠØ± Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©
16. âœ… Testing Ø´Ø§Ù…Ù„
17. âœ… Deployment

---

## ğŸ”’ **Ø§Ù„Ø£Ù…Ø§Ù† (Security Considerations)**

1. **Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:** ÙƒÙ„ API endpoint Ù…Ø­Ù…ÙŠ Ø¨Ù€ Middleware
2. **ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:** Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Crypto API Ù„ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©
3. **CSRF Protection:** Ø¬Ù…ÙŠØ¹ POST requests Ù…Ø­Ù…ÙŠØ©
4. **Validation:** Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
5. **Rate Limiting:** ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©

---

## ğŸ“Š **Metrics & Monitoring**

1. **Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©**
2. **Ù†Ø³Ø¨Ø© Ù†Ø¬Ø§Ø­ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©**
3. **Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©**
4. **Ø­Ø¬Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©**
5. **Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©**

---

## ğŸ¯ **Ø§Ù„Ø®Ù„Ø§ØµØ©**

Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙŠØªØ·Ù„Ø¨:
- **200+ Ù…Ù„Ù** Ø¬Ø¯ÙŠØ¯
- **20+ API Endpoint**
- **10+ JavaScript Classes**
- **ØªÙƒØ§Ù…Ù„ ÙƒØ§Ù…Ù„** Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ

**Ù‡Ù„ Ù†Ø¨Ø¯Ø£ Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø¢Ù†ØŸ** ğŸš€
